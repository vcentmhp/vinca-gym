<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perpanjang Membership - Vinca Gym</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #121212; color: #e0e0e0; }
        .card { background: #242424; border-radius: 1rem; border: 1px solid #333333; }
        .btn-primary { background-color: #ffffff; color: #121212; font-weight: 600; transition: all 0.3s ease; }
        .btn-primary:hover { background-color: #dcdcdc; }
        .btn-success { background-color: #10b981; color: white; font-weight: 600; transition: all 0.3s ease; }
        .btn-success:hover { background-color: #059669; }
        .btn-secondary { background-color: #6b7280; color: white; font-weight: 600; transition: all 0.3s ease; }
        .btn-secondary:hover { background-color: #4b5563; }
        input, textarea, input[type="date"] { background-color: #333; border: 1px solid #555; color: white; }
        .paket-card { cursor: pointer; transition: all 0.2s ease-in-out; border: 2px solid #333; }
        .paket-card:hover { border-color: #777; transform: translateY(-4px); }
        .paket-card.selected { border-color: #fff; background-color: #333; }
        .copy-btn { background-color: transparent; border: none; cursor: pointer; }
        .tooltip { visibility: hidden; opacity: 0; transition: opacity 0.3s; }
        .copy-btn:hover .tooltip { visibility: visible; opacity: 1; }
        .voucher-section { border: 1px dashed #6b7280; border-radius: 0.75rem; background: #1f2937; padding: 1rem; margin: 1rem 0; }
        .voucher-success { border-color: #10b981; background: rgba(16, 185, 129, 0.1); }
        .voucher-error { border-color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        .voucher-hidden { display: none; }
        .voucher-link { color: #93c5fd; text-decoration: underline; cursor: pointer; font-size: 0.875rem; }
        .voucher-link:hover { color: #bfdbfe; }
        .discount-highlight { color: #10b981; font-weight: 600; }
        .original-price { text-decoration: line-through; color: #9ca3af; }
    </style>
</head>
<body class="antialiased">
    <!-- Header -->
    <header class="bg-black/80 backdrop-blur-lg sticky top-0 z-50 shadow-lg shadow-black/20">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="flex items-center gap-3 text-2xl font-bold text-white">
                <img src="https://i.imgur.com/upiRXbW.png" alt="Vinca Gym Logo" class="h-10 w-auto">
                <span>Vinca Gym</span>
            </a>
        </nav>
    </header>
    <!-- Main Content -->
    <main class="min-h-screen flex items-center justify-center py-12 px-4">
        <!-- Tahap 1: Verifikasi Member -->
        <div id="verifikasi-container" class="card p-8 w-full max-w-lg text-center">
            <h1 class="text-3xl font-bold text-white mb-4">Perpanjang Membership</h1>
            <p class="text-gray-400 mb-6">Silakan masukkan No. Member Anda untuk melanjutkan.</p>
            <form id="verifikasi-form">
                <div class="mb-4">
                    <label for="no-member" class="block text-sm font-medium text-gray-300 mb-1 text-left">No. Member</label>
                    <input type="text" id="no-member" class="w-full px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-white font-mono" placeholder="Contoh: VG-R0001" required>
                </div>
                <button type="submit" id="submit-verifikasi" class="w-full btn-primary py-3 rounded-md flex items-center justify-center">
                    <span id="verifikasi-text">Cari Member</span>
                    <div id="verifikasi-spinner" class="w-5 h-5 border-2 border-black border-dashed rounded-full animate-spin hidden ml-2"></div>
                </button>
                <p id="verifikasi-error" class="text-red-400 text-sm mt-4 hidden">No. Member tidak ditemukan.</p>
            </form>
        </div>

        <!-- Tahap 2: Detail & Pilihan Paket -->
        <div id="perpanjang-container" class="hidden w-full max-w-4xl">
            <div class="card p-8">
                <h1 class="text-3xl font-bold text-white mb-2">Selamat Datang Kembali, <span id="nama-member" class="text-yellow-400"></span>!</h1>
                <p class="text-gray-400">Membership Anda saat ini akan berakhir pada: <strong id="tanggal-selesai-lama" class="text-white"></strong></p>
                <hr class="border-gray-700 my-6">
                <h2 class="text-2xl font-bold text-white mb-4">Pilih Paket Perpanjangan</h2>
                <div id="paket-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Paket akan dimuat di sini oleh JS -->
                </div>

                <!-- Voucher Section -->
                <div class="voucher-section voucher-hidden" id="voucher-section">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-white font-semibold">Kode Voucher</h3>
                        <button id="close-voucher-btn" class="text-gray-400 hover:text-white">
                            <i class="ph ph-x text-lg"></i>
                        </button>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="voucher-code" class="flex-1 px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-white uppercase" placeholder="Masukkan kode voucher">
                        <button id="apply-voucher-btn" class="btn-secondary px-4 py-2 rounded-md flex items-center">
                            <span id="voucher-btn-text">Terapkan</span>
                            <div id="voucher-spinner" class="w-4 h-4 border-2 border-white border-dashed rounded-full animate-spin hidden ml-2"></div>
                        </button>
                    </div>
                    <div id="voucher-message" class="mt-2 text-sm hidden"></div>
                    <div id="voucher-details" class="mt-3 p-3 bg-green-900/20 rounded-lg border border-green-500/30 hidden">
                        <div class="flex items-center gap-2 text-green-400">
                            <i class="ph ph-check-circle"></i>
                            <span class="font-semibold">Voucher Berhasil Diterapkan!</span>
                        </div>
                        <div class="mt-2 text-sm text-green-300">
                            <div id="voucher-info"></div>
                        </div>
                    </div>
                </div>

                <div id="rincian-container" class="hidden mt-6 bg-gray-800/50 p-6 rounded-lg border border-gray-700">
                     <h2 class="text-xl font-semibold text-white mb-4">Rincian Biaya</h2>
                     <div class="space-y-2 text-gray-300">
                        <div class="flex justify-between"><span>Paket Pilihan:</span><strong id="paket-pilihan-nama" class="text-white"></strong></div>
                        <div class="flex justify-between"><span>Harga Paket:</span><span id="paket-harga-display">Rp 0</span></div>
                        <div id="voucher-discount-container" class="flex justify-between hidden">
                            <span>Diskon Voucher:</span>
                            <span id="voucher-discount-amount" class="discount-highlight">-Rp 0</span>
                        </div>
                        <hr class="border-gray-600 my-2">
                        <div class="flex justify-between text-lg font-bold">
                            <span class="text-white">Total Bayar:</span>
                            <div class="flex items-center gap-2">
                                <span id="total-original" class="original-price text-sm hidden">Rp 0</span>
                                <span id="total-bayar-perpanjang" class="text-white">Rp 0</span>
                            </div>
                        </div>
                     </div>
                     <div class="mt-4">
                        <span class="voucher-link" id="show-voucher-link">Ada kode voucher? Klik di sini</span>
                     </div>
                     <button id="submit-perpanjang" class="w-full btn-primary py-3 rounded-md mt-6">Lanjutkan ke Pembayaran</button>
                </div>
            </div>
        </div>

        <!-- Tahap 3: Halaman Sukses -->
        <div id="success-message" class="hidden text-center max-w-lg w-full">
            <div class="mx-auto bg-green-900/50 w-24 h-24 rounded-full flex items-center justify-center border-2 border-green-500"><i class="ph ph-check-fat text-6xl text-green-400"></i></div>
            <h1 class="text-3xl font-bold mt-6 text-white">Perpanjangan Berhasil!</h1>
            <p class="text-gray-300 mt-2">Terima kasih telah memperpanjang membership Anda. Silakan lakukan pembayaran untuk mengaktifkan perpanjangan.</p>

            <div id="payment-info" class="card p-6 mt-6 text-left">
                <div class="flex items-center justify-between">
                    <p class="text-lg">No. Member Anda: <strong id="kode-sukses" class="text-yellow-400 font-mono"></strong></p>
                    <button id="copy-kode-btn" class="copy-btn relative text-gray-400 hover:text-white"><i class="ph ph-copy"></i><span class="tooltip absolute -top-8 left-1/2 -translate-x-1/2 bg-black text-white text-xs px-2 py-1 rounded">Salin</span></button>
                </div>
                <hr class="border-gray-600 my-4">
                <h3 class="font-bold text-white mb-2">Metode Pembayaran:</h3>
                <div class="flex flex-col md:flex-row gap-4 items-center">
                    <!-- QRIS -->
                    <div class="w-full md:w-1/2 flex flex-col items-center">
                        <img src="qris-logo.png" alt="QRIS Logo" class="h-6 mb-3">
                        <img src="qris-code.png" alt="QRIS Code" class="rounded-lg w-40 h-40 border-4 border-white">
                    </div>
                    <!-- Bank Transfer -->
                    <div class="w-full md:w-1/2 flex flex-col items-center md:items-start">
                        <img src="bca-logo.png" alt="BCA Logo" class="h-6 mb-3">
                        <p class="font-semibold">Bank BCA</p>
                        <div class="flex items-center gap-2">
                           <p id="rekening-nomor" class="font-mono text-lg">4060622839</p>
                           <button id="copy-rekening-btn" class="copy-btn relative text-gray-400 hover:text-white"><i class="ph ph-copy"></i><span class="tooltip absolute -top-8 left-1/2 -translate-x-1/2 bg-black text-white text-xs px-2 py-1 rounded">Salin</span></button>
                        </div>
                        <p>a.n. RIMA RIZKY AMELIA</p>
                    </div>
                </div>
                <p class="text-xs text-gray-400 mt-4 text-center italic">
                    Harap konfirmasi dan mengirimkan foto bukti transfer melalui nomor Whatsapp kami dibawah ini. Barakallahu fiik.
                </p>
            </div>

            <div class="mt-6 flex flex-col sm:flex-row gap-4">
                <button id="download-payment-btn" class="w-full bg-gray-600 text-white py-3 rounded-md flex items-center justify-center gap-2 hover:bg-gray-700">
                    <i id="download-icon" class="ph ph-download-simple"></i>
                    <span id="download-text">Unduh Info Pembayaran</span>
                    <div id="download-spinner" class="w-5 h-5 border-2 border-white border-dashed rounded-full animate-spin hidden"></div>
                </button>
                <a id="whatsapp-confirm-btn" href="#" target="_blank" class="w-full bg-green-500 text-white py-3 rounded-md flex items-center justify-center gap-2 hover:bg-green-600"><i class="ph ph-whatsapp-logo"></i>Konfirmasi via WhatsApp</a>
            </div>
             <a href="index.html" class="mt-4 inline-block text-gray-400 hover:text-white py-3 px-8 rounded-md">Kembali ke Halaman Utama</a>
        </div>
    </main>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, runTransaction, getDoc, query, where, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        const firebaseConfig = { apiKey: "AIzaSyBJsVSa2KVdB7w3A-5c9i5MqcpdaqZ_lqQ", authDomain: "vinca-gym-website.firebaseapp.com", projectId: "vinca-gym-website", storageBucket: "vinca-gym-website.firebasestorage.app", messagingSenderId: "430179505282", appId: "1:430179505282:web:e7128a258fb64cebcb109b", measurementId: "G-5KVHK8RPK9" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const PAKET_MEMBERSHIP = {
            regular: { nama: "Regular (1 Bulan)", harga: 200000, prefix: "R", durasiBulan: 1 },
            silver: { nama: "Silver (3 Bulan)", harga: 525000, prefix: "S", durasiBulan: 3 },
            gold: { nama: "Gold (6 Bulan)", harga: 900000, prefix: "G", durasiBulan: 6 },
            platinum: { nama: "Platinum (1 Tahun)", harga: 1200000, prefix: "P", durasiBulan: 12 }
        };

        let memberDataGlobal = null;
        let memberDocId = null;
        let paketTerpilih = null;
        let appliedVoucher = null;
        let totalHargaAwal = 0;
        let totalHargaAkhir = 0;

        function formatRupiah(angka) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka); }
        function formatDate(timestamp) { return timestamp ? new Date(timestamp.seconds * 1000).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' }) : '-'; }

        function copyToClipboard(text, buttonElement) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);

            const originalIcon = buttonElement.innerHTML;
            const tooltip = buttonElement.querySelector('.tooltip');
            buttonElement.innerHTML = '<i class="ph ph-check text-green-400"></i>';
            if (tooltip) tooltip.textContent = 'Tersalin!';

            setTimeout(() => {
                buttonElement.innerHTML = originalIcon;
                if (tooltip) tooltip.textContent = 'Salin';
            }, 2000);
        }

        // Voucher Management Functions
        async function validateVoucherCode(voucherCode) {
            try {
                const q = query(collection(db, "vouchers"), where("code", "==", voucherCode.toUpperCase()), where("isActive", "==", true));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    return { valid: false, message: "Kode voucher tidak valid atau sudah tidak aktif" };
                }

                const voucherDoc = querySnapshot.docs[0];
                const voucherData = voucherDoc.data();
                const now = new Date();

                // Check expiry date
                if (voucherData.expiryDate && voucherData.expiryDate.toDate() < now) {
                    return { valid: false, message: "Kode voucher sudah kedaluwarsa" };
                }

                // Check usage limit
                if (voucherData.maxUses && voucherData.currentUses >= voucherData.maxUses) {
                    return { valid: false, message: "Kode voucher sudah mencapai batas penggunaan" };
                }

                // Check minimum purchase amount
                if (voucherData.minPurchase && totalHargaAwal < voucherData.minPurchase) {
                    return { 
                        valid: false, 
                        message: `Minimum pembelian ${formatRupiah(voucherData.minPurchase)} untuk menggunakan voucher ini` 
                    };
                }

                return { 
                    valid: true, 
                    voucher: { id: voucherDoc.id, ...voucherData },
                    message: "Voucher berhasil diterapkan!"
                };

            } catch (error) {
                console.error("Error validating voucher:", error);
                return { valid: false, message: "Terjadi kesalahan saat memvalidasi voucher" };
            }
        }

        function calculateDiscount(voucher, totalAmount) {
            let discountAmount = 0;

            if (voucher.discountType === 'percentage') {
                discountAmount = (totalAmount * voucher.discountValue) / 100;
                // Apply max discount if specified
                if (voucher.maxDiscount && discountAmount > voucher.maxDiscount) {
                    discountAmount = voucher.maxDiscount;
                }
            } else if (voucher.discountType === 'fixed') {
                discountAmount = voucher.discountValue;
            }

            // Ensure discount doesn't exceed total amount
            discountAmount = Math.min(discountAmount, totalAmount);

            return discountAmount;
        }

        function updatePriceDisplay() {
            const voucherDiscountContainer = document.getElementById('voucher-discount-container');
            const voucherDiscountAmount = document.getElementById('voucher-discount-amount');
            const totalOriginal = document.getElementById('total-original');
            const totalBayar = document.getElementById('total-bayar-perpanjang');

            if (appliedVoucher) {
                const discountAmount = calculateDiscount(appliedVoucher, totalHargaAwal);
                totalHargaAkhir = totalHargaAwal - discountAmount;

                voucherDiscountAmount.textContent = `-${formatRupiah(discountAmount)}`;
                voucherDiscountContainer.classList.remove('hidden');

                totalOriginal.textContent = formatRupiah(totalHargaAwal);
                totalOriginal.classList.remove('hidden');
                totalBayar.textContent = formatRupiah(totalHargaAkhir);
                totalBayar.classList.add('discount-highlight');
            } else {
                voucherDiscountContainer.classList.add('hidden');
                totalOriginal.classList.add('hidden');
                totalBayar.textContent = formatRupiah(totalHargaAwal);
                totalBayar.classList.remove('discount-highlight');
                totalHargaAkhir = totalHargaAwal;
            }
        }

        // Voucher UI Event Handlers
        document.getElementById('show-voucher-link').addEventListener('click', () => {
            document.getElementById('voucher-section').classList.remove('voucher-hidden');
            document.getElementById('voucher-code').focus();
        });

        document.getElementById('close-voucher-btn').addEventListener('click', () => {
            document.getElementById('voucher-section').classList.add('voucher-hidden');
            document.getElementById('voucher-code').value = '';
            document.getElementById('voucher-message').classList.add('hidden');
            document.getElementById('voucher-details').classList.add('hidden');
        });

        document.getElementById('apply-voucher-btn').addEventListener('click', async (e) => {
            // Handle remove voucher if already applied
            if (appliedVoucher && document.getElementById('voucher-btn-text').textContent === 'Hapus') {
                e.preventDefault();
                e.stopPropagation();

                // Reset voucher state
                appliedVoucher = null;
                document.getElementById('voucher-code').value = '';
                document.getElementById('voucher-code').disabled = false;
                document.getElementById('voucher-btn-text').textContent = 'Terapkan';
                document.getElementById('voucher-details').classList.add('hidden');
                document.getElementById('voucher-section').classList.remove('voucher-success', 'voucher-error');

                updatePriceDisplay();
                return;
            }

            const voucherCode = document.getElementById('voucher-code').value.trim();
            const applyBtn = document.getElementById('apply-voucher-btn');
            const btnText = document.getElementById('voucher-btn-text');
            const spinner = document.getElementById('voucher-spinner');
            const messageDiv = document.getElementById('voucher-message');
            const detailsDiv = document.getElementById('voucher-details');
            const voucherSection = document.getElementById('voucher-section');

            if (!voucherCode) {
                messageDiv.textContent = "Silakan masukkan kode voucher";
                messageDiv.className = "mt-2 text-sm text-red-400";
                messageDiv.classList.remove('hidden');
                return;
            }

            // Loading state
            applyBtn.disabled = true;
            btnText.classList.add('hidden');
            spinner.classList.remove('hidden');
            messageDiv.classList.add('hidden');
            detailsDiv.classList.add('hidden');

            const result = await validateVoucherCode(voucherCode);

            if (result.valid) {
                appliedVoucher = result.voucher;
                const discountAmount = calculateDiscount(appliedVoucher, totalHargaAwal);

                // Show success state
                voucherSection.classList.add('voucher-success');
                voucherSection.classList.remove('voucher-error');

                document.getElementById('voucher-info').innerHTML = `
                    <div>Kode: <strong>${appliedVoucher.code}</strong></div>
                    <div>Deskripsi: ${appliedVoucher.description || 'Diskon spesial'}</div>
                    <div>Diskon: ${formatRupiah(discountAmount)}</div>
                `;
                detailsDiv.classList.remove('hidden');

                updatePriceDisplay();

                // Change button to "Hapus"
                btnText.textContent = 'Hapus';
                document.getElementById('voucher-code').disabled = true;

            } else {
                // Show error state
                voucherSection.classList.add('voucher-error');
                voucherSection.classList.remove('voucher-success');

                messageDiv.textContent = result.message;
                messageDiv.className = "mt-2 text-sm text-red-400";
                messageDiv.classList.remove('hidden');
            }

            // Reset loading state
            applyBtn.disabled = false;
            btnText.classList.remove('hidden');
            spinner.classList.add('hidden');
        });

        async function handleVerifikasiSubmit(e) {
            e.preventDefault();
            const noMemberInput = document.getElementById('no-member').value.trim().toUpperCase();
            const submitButton = document.getElementById('submit-verifikasi');
            const verifikasiText = document.getElementById('verifikasi-text');
            const verifikasiSpinner = document.getElementById('verifikasi-spinner');
            const verifikasiError = document.getElementById('verifikasi-error');

            submitButton.disabled = true;
            verifikasiText.classList.add('hidden');
            verifikasiSpinner.classList.remove('hidden');
            verifikasiError.classList.add('hidden');

            try {
                const q = query(collection(db, "pendaftaran_member"), where("kodePendaftaran", "==", noMemberInput));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    throw new Error("No. Member tidak ditemukan.");
                }

                const memberDoc = querySnapshot.docs[0];
                memberDocId = memberDoc.id;
                memberDataGlobal = memberDoc.data();

                document.getElementById('nama-member').textContent = memberDataGlobal.nama;
                document.getElementById('tanggal-selesai-lama').textContent = formatDate(memberDataGlobal.tanggalSelesai);

                const paketContainer = document.getElementById('paket-container');
                let paketCardsHtml = '';
                for (const key in PAKET_MEMBERSHIP) {
                    const paket = PAKET_MEMBERSHIP[key];
                    paketCardsHtml += `
                        <div class="card p-4 text-center paket-card" data-paket-key="${key}">
                            <h3 class="font-bold">${paket.nama}</h3>
                            <p class="text-lg font-semibold my-2">${formatRupiah(paket.harga)}</p>
                        </div>
                    `;
                }
                paketContainer.innerHTML = paketCardsHtml;

                document.getElementById('verifikasi-container').classList.add('hidden');
                document.getElementById('perpanjang-container').classList.remove('hidden');

                document.querySelectorAll('.paket-card').forEach(card => {
                    card.addEventListener('click', (event) => handlePaketSelection(event.currentTarget.dataset.paketKey));
                });

            } catch (error) {
                verifikasiError.textContent = error.message;
                verifikasiError.classList.remove('hidden');
            } finally {
                submitButton.disabled = false;
                verifikasiText.classList.remove('hidden');
                verifikasiSpinner.classList.add('hidden');
            }
        }

        function handlePaketSelection(paketKey) {
            paketTerpilih = PAKET_MEMBERSHIP[paketKey];
            totalHargaAwal = paketTerpilih.harga;
            totalHargaAkhir = totalHargaAwal;

            // Reset voucher if changing packages
            if (appliedVoucher) {
                appliedVoucher = null;
                document.getElementById('voucher-section').classList.add('voucher-hidden');
                document.getElementById('voucher-code').value = '';
                document.getElementById('voucher-code').disabled = false;
                document.getElementById('voucher-btn-text').textContent = 'Terapkan';
                document.getElementById('voucher-details').classList.add('hidden');
                document.getElementById('voucher-section').classList.remove('voucher-success', 'voucher-error');
            }

            document.querySelectorAll('.paket-card').forEach(card => card.classList.remove('selected'));
            document.querySelector(`[data-paket-key="${paketKey}"]`).classList.add('selected');

            document.getElementById('paket-pilihan-nama').textContent = paketTerpilih.nama;
            document.getElementById('paket-harga-display').textContent = formatRupiah(paketTerpilih.harga);
            document.getElementById('total-bayar-perpanjang').textContent = formatRupiah(paketTerpilih.harga);
            document.getElementById('rincian-container').classList.remove('hidden');

            updatePriceDisplay();
        }

        async function handleSubmitPerpanjangan() {
            if (!paketTerpilih || !memberDocId) return;

            const tanggalMulaiBaru = new Date();
            let tanggalSelesaiLama = new Date(memberDataGlobal.tanggalSelesai.seconds * 1000);

            // Logika Cerdas: Jika perpanjang sebelum habis, tambahkan durasi dari tanggal selesai lama
            const basisPerpanjangan = tanggalSelesaiLama > tanggalMulaiBaru ? tanggalSelesaiLama : tanggalMulaiBaru;
            const tanggalSelesaiBaru = new Date(basisPerpanjangan);
            tanggalSelesaiBaru.setMonth(tanggalSelesaiBaru.getMonth() + paketTerpilih.durasiBulan);

            const dataUpdate = {
                paket: paketTerpilih.nama,
                totalBayar: totalHargaAkhir,
                totalHargaAwal: totalHargaAwal,
                tanggalMulai: tanggalMulaiBaru,
                tanggalSelesai: tanggalSelesaiBaru,
                statusPembayaran: false, // Set status bayar ke belum lunas
                voucherUsed: appliedVoucher ? {
                    code: appliedVoucher.code,
                    discountAmount: calculateDiscount(appliedVoucher, totalHargaAwal),
                    voucherId: appliedVoucher.id
                } : null
            };

            try {
                const memberRef = doc(db, "pendaftaran_member", memberDocId);
                await updateDoc(memberRef, dataUpdate);

                // Update voucher usage if applied
                if (appliedVoucher) {
                    const voucherRef = doc(db, "vouchers", appliedVoucher.id);
                    await runTransaction(db, async (transaction) => {
                        const voucherDoc = await transaction.get(voucherRef);
                        if (voucherDoc.exists()) {
                            const currentUses = voucherDoc.data().currentUses || 0;
                            transaction.update(voucherRef, { currentUses: currentUses + 1 });
                        }
                    });
                }

                document.getElementById('perpanjang-container').classList.add('hidden');
                document.getElementById('kode-sukses').textContent = memberDataGlobal.kodePendaftaran;

                const whatsappMsg = encodeURIComponent(`Bismillah Vinca Gym, saya ${memberDataGlobal.nama} dengan No. Member ${memberDataGlobal.kodePendaftaran} ingin konfirmasi perpanjangan untuk paket ${paketTerpilih.nama}. Total bayar: ${formatRupiah(totalHargaAkhir)}. Barakallahu fiik.`);
                document.getElementById('whatsapp-confirm-btn').href = `https://wa.me/6285782919391?text=${whatsappMsg}`;

                document.getElementById('success-message').classList.remove('hidden');

            } catch (error) {
                console.error("Gagal memperpanjang:", error);
                alert("Gagal memperpanjang membership. Silakan coba lagi.");
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const verifikasiForm = document.getElementById('verifikasi-form');
            const submitPerpanjang = document.getElementById('submit-perpanjang');
            const copyKodeBtn = document.getElementById('copy-kode-btn');
            const downloadPaymentBtn = document.getElementById('download-payment-btn');

            verifikasiForm.addEventListener('submit', handleVerifikasiSubmit);
            submitPerpanjang.addEventListener('click', handleSubmitPerpanjangan);

            copyKodeBtn.addEventListener('click', () => {
                const kode = document.getElementById('kode-sukses').textContent;
                copyToClipboard(kode, copyKodeBtn);
            });

            downloadPaymentBtn.addEventListener('click', () => {
                const paymentInfo = document.getElementById('payment-info');
                html2canvas(paymentInfo, { backgroundColor: '#242424' }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'info-pembayaran-vinca-gym.png';
                    link.href = canvas.toDataURL();
                    link.click();
                });
            });
        });
    </script>
</body>
</html>
