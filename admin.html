<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Vinca Gym</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0b;
            --bg-secondary: #111111;
            --bg-card: #1a1a1b;
            --bg-card-hover: #222223;
            --border-primary: #2a2a2b;
            --border-secondary: #3a3a3b;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --text-tertiary: #8a8a8a;
            --accent-primary: #ffffff;
            --accent-success: #22c55e;
            --accent-warning: #f59e0b;
            --accent-error: #ef4444;
            --accent-info: #3b82f6;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
        }
        
        body { 
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-feature-settings: 'cv11', 'ss01';
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Modern button styles */
        .btn-primary { 
            background: var(--accent-primary);
            color: var(--bg-primary);
            font-weight: 500;
            border-radius: 12px;
            padding: 12px 24px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid transparent;
            font-size: 15px;
            line-height: 1.4;
            box-shadow: var(--shadow-sm);
        }
        .btn-primary:hover { 
            background: #f0f0f0;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn-secondary { 
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
            font-weight: 500;
            border-radius: 12px;
            padding: 12px 24px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 15px;
            line-height: 1.4;
        }
        .btn-secondary:hover { 
            background: var(--bg-card-hover);
            border-color: var(--border-secondary);
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background: var(--accent-error);
            color: white;
            font-weight: 500;
            border-radius: 12px;
            padding: 12px 24px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid transparent;
            font-size: 15px;
            box-shadow: var(--shadow-sm);
        }
        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-success {
            background: var(--accent-success);
            color: white;
            font-weight: 500;
            border-radius: 12px;
            padding: 12px 24px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid transparent;
            font-size: 15px;
            box-shadow: var(--shadow-sm);
        }
        .btn-success:hover {
            background: #16a34a;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        /* Modern navigation */
        .nav-btn {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid transparent;
            border-radius: 12px;
            padding: 12px 20px;
            font-weight: 500;
            font-size: 15px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        .nav-btn.active {
            background: var(--bg-card);
            color: var(--text-primary);
            border-color: var(--border-primary);
            box-shadow: var(--shadow-sm);
        }
        .nav-btn:hover:not(.active) {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        /* Modern card styles */
        .card { 
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border-primary);
            box-shadow: var(--shadow-sm);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card:hover {
            border-color: var(--border-secondary);
            box-shadow: var(--shadow-md);
        }
        
        .stat-card {
            background: linear-gradient(135deg, var(--bg-card) 0%, #1e1e1f 100%);
            border: 1px solid var(--border-primary);
            border-radius: 20px;
            padding: 24px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--border-secondary);
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
        }
        
        /* Modern form inputs */
        input, select, textarea { 
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 15px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            background: var(--bg-card);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
        }
        input::placeholder {
            color: var(--text-tertiary);
        }
        
        /* Calendar picker styles */
        input[type="time"]::-webkit-calendar-picker-indicator,
        input[type="date"]::-webkit-calendar-picker-indicator { 
            filter: invert(1);
            cursor: pointer;
        }
        
        /* Table row styles */
        .table-row { 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-bottom: 1px solid var(--border-primary);
        }
        .table-row:hover { 
            background: var(--bg-secondary);
        }
        .unpaid-row { 
            background: rgba(239, 68, 68, 0.05);
            border-left: 3px solid var(--accent-error);
        }
        .unpaid-row:hover { 
            background: rgba(239, 68, 68, 0.1);
        }
        .expiring-row { 
            background: rgba(245, 158, 11, 0.05);
            border-left: 3px solid var(--accent-warning);
        }
        .expiring-row:hover { 
            background: rgba(245, 158, 11, 0.1);
        }
        .member-row { 
            cursor: pointer;
        }
        
        /* QR code reader */
        #reader { 
            border: 2px solid var(--border-secondary);
            border-radius: 16px;
            overflow: hidden;
        }
        
        /* Modal styles */
        .modal-backdrop { 
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
        }
        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-secondary);
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
        }
        
        /* Animation utilities */
        .animate-fade-in {
            animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .animate-slide-up {
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--border-secondary);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-tertiary);
        }
        
        /* Typography improvements */
        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            line-height: 1.2;
            letter-spacing: -0.025em;
        }
        
        .text-display {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1.1;
            letter-spacing: -0.05em;
        }
        
        .text-title {
            font-size: 1.5rem;
            font-weight: 600;
            line-height: 1.2;
            letter-spacing: -0.025em;
        }
        
        .text-body {
            font-size: 0.9375rem;
            line-height: 1.5;
            color: var(--text-secondary);
        }
        
        .text-caption {
            font-size: 0.8125rem;
            line-height: 1.4;
            color: var(--text-tertiary);
        }
        
        /* Logo improvements */
        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
        }
        
        /* Success/Error message styles */
        .alert {
            border-radius: 12px;
            padding: 16px 20px;
            border: 1px solid;
            backdrop-filter: blur(10px);
            font-size: 15px;
            font-weight: 500;
        }
        .alert-success {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.2);
            color: var(--accent-success);
        }
        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            border-color: rgba(245, 158, 11, 0.2);
            color: var(--accent-warning);
        }
        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.2);
            color: var(--accent-error);
        }
        .alert-info {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.2);
            color: var(--accent-info);
        }

        /* Pagination Styles */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1.5rem;
            padding: 1rem 0;
            border-top: 1px solid var(--border-primary);
        }
        
        .pagination-info {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .pagination-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .pagination-btn {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 14px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .pagination-btn:hover:not(:disabled) {
            background: var(--bg-card-hover);
            border-color: var(--border-secondary);
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination-btn.active {
            background: var(--accent-primary);
            color: var(--bg-primary);
            border-color: var(--accent-primary);
        }

        /* Legacy compatibility for original JavaScript */
        .card-bg { 
            background-color: #1a1a1a;
            background-image: 
                radial-gradient(circle at top right, rgba(255, 255, 255, 0.08), transparent 40%),
                url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 800"%3E%3Crect fill="%231a1a1a" width="800" height="800"/%3E%3Cg fill-opacity="0.12"%3E%3Ccircle fill="%233a3a3a" cx="400" cy="400" r="600"/%3E%3Ccircle fill="%23353535" cx="400" cy="400" r="500"/%3E%3Ccircle fill="%23303030" cx="400" cy="400" r="400"/%3E%3Ccircle fill="%232b2b2b" cx="400" cy="400" r="300"/%3E%3Ccircle fill="%23262626" cx="400" cy="400" r="200"/%3E%3Ccircle fill="%23242424" cx="400" cy="400" r="100"/%3E%3C/g%3E%3C/svg%3E');
        }
        .aspect-4-3 { 
            aspect-ratio: 4 / 3; 
        }
        #render-qrcode img { 
            margin: auto;
            border-radius: 0.25rem;
        }
    </style>
</head>
<body class="antialiased">
    <!-- Login Section -->
    <div id="login-section" class="min-h-screen flex items-center justify-center bg-black">
        <div class="card p-8 w-full max-w-sm text-center">
            <img src="logo.png" alt="Vinca Gym Logo" class="h-20 w-auto mx-auto mb-4">
            <h1 class="text-2xl font-bold text-center text-white mb-2">Vinca Gym</h1>
            <h2 class="text-l font-semibold text-center text-white mb-8">Admin Panel</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="password" class="block text-sm font-semibold text-gray-300 mb-2 text-left">Masukkan Kata Sandi</label>
                    <div class="relative">
                        <input type="password" id="password" autocomplete="current-password" 
                               class="w-full px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-white pr-10" required
                               placeholder="kata sandi admin">
                        <button type="button" id="toggle-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-white">
                            <i id="eye-icon" class="ph ph-eye"></i>
                        </button>
                    </div>
                </div>
                <p id="login-error" class="text-red-400 text-sm mb-4 hidden">Kata sandi salah.</p>
                <button type="submit" class="w-full font-semibold btn-primary py-2 rounded-md">
                    <span class="flex items-center justify-center gap-2">
                        <i class="ph ph-sign-in text-lg"></i>
                        Masuk
                    </span>
                </button>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-dashboard" class="hidden">
        <!-- Header -->
        <header class="sticky top-0 z-50 backdrop-blur-xl bg-black/80 border-b border-border-primary">
            <div class="max-w-7xl mx-auto px-6 py-6">
                <div class="flex items-center justify-between mb-6">
                    <div class="logo-container">
                        <img src="logo.png" alt="Vinca Gym Logo" class="h-10 w-auto">
                        <div>
                            <h1 class="text-title text-white">Dashboard Admin</h1>
                            <p class="text-caption">Sistem Manajemen Vinca Gym</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-3">
                        <div class="text-right">
                            <p class="text-sm text-primary font-medium" id="current-time"></p>
                            <p class="text-caption">Indonesia</p>
                        </div>
                        <div class="w-10 h-10 bg-gradient-to-br from-white/10 to-white/5 rounded-full flex items-center justify-center border border-border-primary">
                            <i class="ph ph-user text-lg text-primary"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Navigation -->
                <div class="flex gap-2 p-1 bg-secondary rounded-2xl border border-border-primary">
                    <button id="show-attendance-btn" class="nav-btn flex-1 flex items-center justify-center gap-2">
                        <i class="ph ph-clock-clockwise text-lg"></i>
                        <span class="font-semibold">Absensi</span>
                    </button>
                    <button id="show-members-btn" class="nav-btn flex-1 flex items-center justify-center gap-2">
                        <i class="ph ph-users text-lg"></i>
                        <span class="font-semibold">Data Member</span>
                    </button>
                    <button id="show-reports-btn" class="nav-btn flex-1 flex items-center justify-center gap-2">
                        <i class="ph ph-chart-bar text-lg"></i>
                        <span class="font-semibold">Laporan</span>
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-6 py-8">
            <!-- Summary Section -->
            <section id="summary" class="mb-12 grid grid-cols-1 md:grid-cols-3 gap-6 animate-fade-in">
                <div class="stat-card group">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500/20 to-blue-600/20 rounded-xl flex items-center justify-center border border-blue-500/10">
                            <i class="ph ph-users text-xl text-blue-400"></i>
                        </div>
                        <div class="text-right">
                            <p class="text-caption">Total</p>
                            <p class="text-display" id="total-pendaftar">0</p>
                        </div>
                    </div>
                    <h3 class="text-body font-medium">Total Pendaftar</h3>
                    <div class="mt-2 flex items-center gap-2">
                        <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></div>
                        <span class="text-caption">Member terdaftar</span>
                    </div>
                </div>
                
                <div class="stat-card group">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-500/20 to-green-600/20 rounded-xl flex items-center justify-center border border-green-500/10">
                            <i class="ph ph-check-circle text-xl text-green-400"></i>
                        </div>
                        <div class="text-right">
                            <p class="text-caption">Lunas</p>
                            <p class="text-display text-green-400" id="sudah-bayar">0</p>
                        </div>
                    </div>
                    <h3 class="text-body font-medium">Sudah Bayar</h3>
                    <div class="mt-2 flex items-center gap-2">
                        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                        <span class="text-caption">Pembayaran lunas</span>
                    </div>
                </div>
                
                <div class="stat-card group">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-red-500/20 to-red-600/20 rounded-xl flex items-center justify-center border border-red-500/10">
                            <i class="ph ph-warning-circle text-xl text-red-400"></i>
                        </div>
                        <div class="text-right">
                            <p class="text-caption">Pending</p>
                            <p class="text-display text-red-400" id="belum-bayar">0</p>
                        </div>
                    </div>
                    <h3 class="text-body font-medium">Belum Bayar</h3>
                    <div class="mt-2 flex items-center gap-2">
                        <div class="w-2 h-2 bg-red-400 rounded-full animate-pulse"></div>
                        <span class="text-caption">Menunggu pembayaran</span>
                    </div>
                </div>
            </section>
            
            <!-- Attendance View -->
            <div id="attendance-view" class="animate-slide-up">
                <!-- Attendance Section -->
                <section id="attendance-section" class="mb-12">
                    <div class="card p-8">
                        <div class="flex items-center gap-3 mb-8">
                            <div class="w-12 h-12 bg-gradient-to-br from-purple-500/20 to-purple-600/20 rounded-xl flex items-center justify-center border border-purple-500/10">
                                <i class="ph ph-qr-code text-xl text-purple-400"></i>
                            </div>
                            <div>
                                <h2 class="text-title text-primary">Absensi Check In - Out</h2>
                                <p class="text-body">Kelola absensi member dan pengunjung</p>
                            </div>
                        </div>
                        
                        <div class="space-y-8">
                            <!-- Member Attendance -->
                            <div class="space-y-6">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 bg-gradient-to-br from-blue-500/20 to-blue-600/20 rounded-lg flex items-center justify-center">
                                        <i class="ph ph-identification-card text-blue-400"></i>
                                    </div>
                                    <h3 class="text-lg font-semibold text-primary">Absensi Member</h3>
                                </div>
                                
                                <div class="flex flex-col lg:flex-row gap-4">
                                    <button id="start-scan-btn" class="btn-success flex items-center justify-center gap-3 flex-shrink-0">
                                        <i class="ph ph-qr-code text-xl"></i>
                                        <span>Scan QR Code</span>
                                    </button>
                                    
                                    <form id="manual-checkin-form" class="flex-grow flex gap-3">
                                        <input type="text" id="manual-no-member" 
                                        class="w-full px-3 py-2"
                                        placeholder="atau masukkan no. member manual (contoh: VG-0001)">
                                        <button type="submit" class="btn-primary px-6">
                                            <i class="ph ph-arrow-right text-lg"></i>
                                        </button>
                                    </form>
                                </div>
                                
                                <div id="checkin-result" class=""></div>
                            </div>
                            
                            <div class="border-t border-border-primary"></div>
                            
                            <!-- Visitor Attendance -->
                            <div class="space-y-6">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 bg-gradient-to-br from-orange-500/20 to-orange-600/20 rounded-lg flex items-center justify-center">
                                        <i class="ph ph-user-plus text-orange-400"></i>
                                    </div>
                                    <h3 class="text-lg font-semibold text-primary">Absensi Pengunjung</h3>
                                </div>
                                
                                <form id="visitor-form" class="flex flex-col lg:flex-row gap-4">
                                    <input type="text" id="visitor-name" class="w-full px-3 py-2" 
                                           placeholder="Nama Pengunjung" required>
                                    <input type="text" id="visitor-whatsapp" class="w-full px-3 py-2" 
                                           placeholder="Nomor WhatsApp (Opsional)">
                                    <button type="submit" class="btn-primary px-6 py-2 rounded-lg font-semibold">Simpan</button>
                                </form>
                                
                                <div id="visitor-result" class=""></div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Attendance History -->
                <section id="attendance-history-section" class="mb-12">
                    <div class="card p-8">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-12 h-12 bg-gradient-to-br from-green-500/20 to-green-600/20 rounded-xl flex items-center justify-center border border-green-500/10">
                                <i class="ph ph-clock-clockwise text-xl text-green-400"></i>
                            </div>
                            <div>
                                <h2 class="text-title text-primary">Aktivitas Absensi Hari Ini</h2>
                                <p class="text-body">Riwayat check in-out member & non-member</p>
                            </div>
                        </div>
                        
                        <div id="attendance-history-content" class="overflow-hidden">
                            <div class="flex items-center justify-center py-12">
                                <div class="text-center">
                                    <div class="w-16 h-16 bg-gradient-to-br from-gray-500/20 to-gray-600/20 rounded-xl flex items-center justify-center mx-auto mb-4">
                                        <i class="ph ph-clock text-2xl text-gray-400"></i>
                                    </div>
                                    <p class="text-body">Memuat riwayat absensi...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Export Section -->
                <section id="export-history-section" class="mb-12">
                    <div class="card p-8">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-12 h-12 bg-gradient-to-br from-indigo-500/20 to-indigo-600/20 rounded-xl flex items-center justify-center border border-indigo-500/10">
                                <i class="ph ph-download-simple text-xl text-indigo-400"></i>
                            </div>
                            <div>
                                <h2 class="text-title text-primary">Unduh Laporan Absensi</h2>
                                <p class="text-body">Export data absensi dalam format Excel</p>
                            </div>
                        </div>
                        
                        <div class="flex flex-col md:flex-row gap-4 items-center">
                            <div class="flex-1">
                                <label for="start-date" class="block text-sm font-medium text-gray-300 mb-1">Tanggal Mulai</label>
                                <input type="date" id="start-date" class="w-full px-3 py-2">
                            </div>
                            <div class="flex-1">
                                <label for="end-date" class="block text-sm font-medium text-gray-300 mb-1">Tanggal Selesai</label>
                                <input type="date" id="end-date" class="w-full px-3 py-2">
                            </div>
                            
                            <button id="export-attendance-btn" class="btn-primary flex items-center gap-3 px-8 font-semibold">
                                <i class="ph ph-download-simple text-lg"></i>
                                <span>Unduh Laporan</span>
                            </button>
                        </div>
                        
                        <div id="export-attendance-message" class="mt-4"></div>
                    </div>
                </section>
            </div>

            <!-- Members View -->
            <div id="members-view" class="hidden animate-slide-up">
                <section id="pendaftaran-member" class="mb-12">
                    <!-- Header Section -->
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-cyan-500/20 to-cyan-600/20 rounded-xl flex items-center justify-center border border-cyan-500/10">
                            <i class="ph ph-users text-xl text-cyan-400"></i>
                        </div>
                        <div>
                            <h2 class="text-title text-primary">Data Member</h2>
                            <p class="text-body">Kelola data member aktif dan arsip</p>
                        </div>
                    </div>
                    
                    <!-- Tab Navigation -->
                    <div class="flex gap-2 p-1 bg-secondary rounded-xl border border-border-primary mb-6">
                        <button id="tab-active-members" class="nav-btn flex-1 flex items-center justify-center gap-2 active">
                            <i class="ph ph-users text-lg"></i>
                            <span class="font-semibold">Member Aktif</span>
                        </button>
                        <button id="tab-archive" class="nav-btn flex-1 flex items-center justify-center gap-2">
                            <i class="ph ph-archive text-lg"></i>
                            <span class="font-semibold">Ruang Arsip</span>
                        </button>
                    </div>
                    
                    <!-- Active Members Tab -->
                    <div id="active-members-tab" class="tab-content">
                        <div id="member-table-view">
                            <!-- Search & Filter Section -->
                            <div class="flex flex-col lg:flex-row gap-4 mb-6">
                            <div class="flex flex-col sm:flex-row gap-3 flex-1">
                                <div class="relative flex-1">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="ph ph-magnifying-glass text-tertiary"></i>
                                    </div>
                                    <input type="text" id="search-member-input" 
                                           placeholder="Cari nama atau no. member" 
                                           class="w-full px-10 py-2">
                                </div>
                                <select id="filter-paket" class="px-4 py-2 sm:w-44">
                                    <option value="">Semua Paket</option>
                                    <option value="Regular">Regular</option>
                                    <option value="Silver">Silver</option>
                                    <option value="Gold">Gold</option>
                                    <option value="Platinum">Platinum</option>
                                </select>
                                <select id="filter-status" class="px-4 py-2 sm:w-44">
                                    <option value="">Semua Status</option>
                                    <option value="lunas">Lunas</option>
                                    <option value="belum">Belum Bayar</option>
                                    <option value="expired">Expired</option>
                                    <option value="aktif">Aktif</option>
                                </select>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="flex gap-3">
                                <button id="archive-members-btn" class="btn-danger flex items-center gap-2 px-6 whitespace-nowrap">
                                    <i class="ph ph-archive text-lg"></i>
                                    <span>Arsipkan</span>
                                </button>
                                <button id="export-member-btn" class="btn-secondary flex items-center gap-2 px-6 whitespace-nowrap">
                                    <i class="ph ph-download-simple text-lg"></i>
                                    <span>Unduh</span>
                                </button>
                            </div>
                        </div>
                        
                        <div id="archive-message" class="mb-6"></div>
                        
                        <div class="card p-8">
                            <div id="member-content">
                                <div class="flex items-center justify-center py-12">
                                    <div class="text-center">
                                        <div class="w-16 h-16 bg-gradient-to-br from-gray-500/20 to-gray-600/20 rounded-xl flex items-center justify-center mx-auto mb-4">
                                            <i class="ph ph-users text-2xl text-gray-400"></i>
                                        </div>
                                        <p class="text-body">Memuat data pendaftar...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Pagination Container -->
                            <div id="pagination-container" class="pagination-container hidden">
                                <div class="pagination-info" id="pagination-info">
                                    <!-- Info akan diisi oleh JavaScript -->
                                </div>
                                <div class="pagination-controls" id="pagination-controls">
                                    <!-- Tombol pagination akan diisi oleh JavaScript -->
                                </div>
                            </div>
                        </div>
                        </div>
                        <!-- End member-table-view -->
                        
                        <div id="member-detail-view" class="hidden">
                            <!-- Detail member akan ditampilkan di sini -->
                        </div>
                    </div>
                    <!-- End Active Members Tab -->
                    
                    <!-- Archive Tab -->
                    <div id="archive-tab" class="tab-content hidden">
                        <!-- Search Archive -->
                        <div class="mb-6">
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="ph ph-magnifying-glass text-tertiary"></i>
                                </div>
                                <input type="text" id="search-archive-input" 
                                       placeholder="Cari nama atau no. member di arsip" 
                                       class="w-full px-10 py-2">
                            </div>
                        </div>

                        <div id="archive-message-display" class="mb-6"></div>

                        <!-- Archive Table -->
                        <div class="card p-8">
                            <div id="archive-content">
                                <div class="flex items-center justify-center py-12">
                                    <div class="text-center">
                                        <div class="w-16 h-16 bg-gradient-to-br from-gray-500/20 to-gray-600/20 rounded-xl flex items-center justify-center mx-auto mb-4">
                                            <i class="ph ph-archive text-2xl text-gray-400"></i>
                                        </div>
                                        <p class="text-body">Memuat data arsip...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- End Archive Tab -->
                </section>
            </div>
            
            <!-- Reports View (TAMPILAN BARU) -->
            <div id="reports-view" class="hidden animate-slide-up">
                <section id="laporan-pendapatan" class="space-y-8">
                    <!-- Header Laporan -->
                    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-gradient-to-br from-teal-500/20 to-teal-600/20 rounded-xl flex items-center justify-center border border-teal-500/10">
                                <i class="ph ph-chart-bar text-xl text-teal-400"></i>
                            </div>
                            <div>
                                <h2 class="text-title text-primary">Laporan Pendapatan</h2>
                                <p id="report-period-title" class="text-body">Pendapatan Vinca Gym</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filter Section -->
                    <div class="card p-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                            <!-- Quick Filters -->
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Filter Cepat</label>
                                <div id="report-filter-buttons" class="flex gap-2 p-1 bg-secondary rounded-xl border border-border-primary">
                                   <button data-period="daily" class="report-period-btn btn-secondary px-4 py-2 text-sm rounded-lg flex-1">Hari Ini</button>
                                   <button data-period="weekly" class="report-period-btn btn-secondary px-4 py-2 text-sm rounded-lg flex-1">Minggu Ini</button>
                                   <button data-period="monthly" class="report-period-btn btn-secondary px-4 py-2 text-sm rounded-lg flex-1">Bulan Ini</button>
                                </div>
                            </div>
                            
                            <!-- Month/Year Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Pilih Bulan</label>
                                <div class="flex gap-2">
                                    <select id="report-month-select" class="w-full py-2"></select>
                                    <select id="report-year-select" class="w-full py-2"></select>
                                </div>
                            </div>

                            <!-- Custom Date Range Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Pilih Rentang Tanggal</label>
                                <div class="flex gap-2 items-center">
                                    <input type="date" id="report-start-date" class="w-full py-2">
                                    <span class="text-gray-400">-</span>
                                    <input type="date" id="report-end-date" class="w-full py-2">
                                    <button id="report-apply-custom-date" class="btn-primary px-4 py-2.5 text-sm rounded-lg">OK</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ringkasan Pendapatan -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <!-- Card Total Pendapatan -->
                        <div class="stat-card p-6 flex flex-col justify-between">
                            <div class="flex items-center justify-between">
                                <h3 class="text-body font-medium text-text-secondary">Total Pendapatan</h3>
                                <div class="w-12 h-12 bg-gradient-to-br from-teal-500/20 to-teal-600/20 rounded-xl flex items-center justify-center border border-teal-500/30">
                                    <i class="ph ph-wallet text-2xl text-teal-300"></i>
                                </div>
                            </div>
                            <div>
                                <p id="report-total-income" class="text-3xl lg:text-4xl font-bold text-teal-300 mt-2">Rp 0</p>
                                <p class="text-caption mt-1">Total dari member & visitor</p>
                            </div>
                        </div>

                        <!-- Card Pendapatan Member -->
                        <div class="stat-card p-6 flex flex-col justify-between">
                            <div class="flex items-center justify-between">
                                <h3 class="text-body font-medium text-text-secondary">Pendapatan Member</h3>
                                 <div class="w-12 h-12 bg-gradient-to-br from-blue-500/20 to-blue-600/20 rounded-xl flex items-center justify-center border border-blue-500/30">
                                    <i class="ph ph-users text-2xl text-blue-300"></i>
                                </div>
                            </div>
                            <div>
                                <p id="report-member-income" class="text-3xl lg:text-4xl font-bold text-white mt-2">Rp 0</p>
                                <p class="text-caption mt-1">Dari pendaftaran baru</p>
                            </div>
                        </div>

                        <!-- Card Pendapatan Visitor -->
                        <div class="stat-card p-6 flex flex-col justify-between">
                            <div class="flex items-center justify-between">
                                <h3 class="text-body font-medium text-text-secondary">Pendapatan Visitor</h3>
                                <div class="w-12 h-12 bg-gradient-to-br from-amber-500/20 to-amber-600/20 rounded-xl flex items-center justify-center border border-amber-500/30">
                                    <i class="ph ph-user-plus text-2xl text-amber-300"></i>
                                </div>
                            </div>
                            <div>
                                <p id="report-visitor-income" class="text-3xl lg:text-4xl font-bold text-white mt-2">Rp 0</p>
                                <p class="text-caption mt-1">Dari kunjungan harian</p>
                            </div>
                        </div>

                        <!-- Card Growth Rate -->
                        <div class="stat-card p-6 flex flex-col justify-between">
                            <div class="flex items-center justify-between">
                                <h3 class="text-body font-medium text-text-secondary">Growth Rate</h3>
                                <div id="report-growth-icon-container" class="w-12 h-12 rounded-xl flex items-center justify-center">
                                    <i id="report-growth-icon" class="ph ph-chart-line text-2xl"></i>
                                </div>
                            </div>
                            <div>
                                <p id="report-growth-rate" class="text-3xl lg:text-4xl font-bold mt-2">-%</p>
                                <p id="report-growth-period" class="text-caption mt-1">vs periode sebelumnya</p>
                            </div>
                        </div>
                    </div>

                    <!-- Detail Laporan -->
                    <div class="card p-8">
                         <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold text-primary">Detail Transaksi</h3>
                            <button id="export-report-btn" class="btn-secondary flex items-center gap-2 px-6">
                                <i class="ph ph-download-simple text-lg"></i>
                                <span>Unduh Laporan</span>
                            </button>
                         </div>
                         <div id="report-details-content" class="space-y-8">
                            <!-- Konten Laporan akan di-generate oleh JS -->
                            <div class="flex items-center justify-center py-12">
                                <div class="text-center">
                                    <div class="w-16 h-16 bg-gradient-to-br from-gray-500/20 to-gray-600/20 rounded-xl flex items-center justify-center mx-auto mb-4">
                                        <i class="ph ph-chart-bar text-2xl text-gray-400"></i>
                                    </div>
                                    <p class="text-body">Pilih periode untuk melihat laporan.</p>
                                </div>
                            </div>
                         </div>
                    </div>
                </section>
            </div>

        </main>
    </div>

    <!-- Scanner Modal -->
    <div id="scanner-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="absolute inset-0 modal-backdrop"></div>
        <div class="relative modal-content p-8 w-full max-w-md animate-slide-up">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-gradient-to-br from-blue-500/20 to-blue-600/20 rounded-xl flex items-center justify-center mx-auto mb-4">
                    <i class="ph ph-qr-code text-2xl text-blue-400"></i>
                </div>
                <h3 class="text-title text-primary">Pindai QR Code Member</h3>
                <p class="text-body mt-2">Arahkan kamera ke QR code member</p>
            </div>
            
            <div id="reader" class="w-full mb-6 bg-secondary"></div>
            
            <button id="stop-scan-btn" class="w-full btn-secondary flex items-center justify-center gap-2">
                <i class="ph ph-x text-lg"></i>
                <span>Tutup Scanner</span>
            </button>
        </div>
    </div>

    <!-- Archive Confirmation Modal -->
    <div id="archive-confirm-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="absolute inset-0 modal-backdrop"></div>
        <div class="relative modal-content p-8 w-full max-w-md text-center animate-slide-up">
            <div class="w-20 h-20 bg-gradient-to-br from-yellow-500/20 to-yellow-600/20 rounded-full flex items-center justify-center mx-auto mb-6 border-2 border-yellow-500/20">
                <i class="ph ph-warning text-3xl text-yellow-400"></i>
            </div>
            
            <h2 class="text-title text-primary mb-3">Konfirmasi Arsip</h2>
            <p class="text-body mb-8">Anda akan mengarsipkan member yang masa aktifnya telah berakhir lebih dari 3 bulan. Data tidak akan dihapus permanen. Lanjutkan?</p>
            
            <div class="flex gap-4">
                <button id="cancel-archive-btn" class="flex-1 btn-secondary">Batal</button>
                <button id="confirm-archive-btn" class="flex-1 btn-danger flex items-center justify-center gap-2">
                    <span id="archive-text">Ya, Arsipkan</span>
                    <div id="archive-spinner" class="w-5 h-5 border-2 border-white border-dashed rounded-full animate-spin hidden"></div>
                </button>
            </div>
        </div>
    </div>

    <!-- Restore Confirmation Modal -->
    <div id="restore-confirm-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="absolute inset-0 modal-backdrop"></div>
        <div class="relative modal-content p-8 w-full max-w-md text-center animate-slide-up">
            <div class="w-20 h-20 bg-gradient-to-br from-green-500/20 to-green-600/20 rounded-full flex items-center justify-center mx-auto mb-6 border-2 border-green-500/20">
                <i class="ph ph-arrow-counter-clockwise text-3xl text-green-400"></i>
            </div>
            
            <h2 class="text-title text-primary mb-3">Konfirmasi Pulihkan</h2>
            <p class="text-body mb-2">Anda akan memulihkan member:</p>
            <p class="text-lg font-semibold text-primary mb-6" id="restore-member-name"></p>
            <p class="text-body mb-8">Member akan dikembalikan ke daftar aktif. Lanjutkan?</p>
            
            <div class="flex gap-4">
                <button id="cancel-restore-btn" class="flex-1 btn-secondary">Batal</button>
                <button id="confirm-restore-btn" class="flex-1 btn-success flex items-center justify-center gap-2">
                    <span id="restore-text">Ya, Pulihkan</span>
                    <div id="restore-spinner" class="w-5 h-5 border-2 border-white border-dashed rounded-full animate-spin hidden"></div>
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-confirm-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="absolute inset-0 modal-backdrop"></div>
        <div class="relative modal-content p-8 w-full max-w-md text-center animate-slide-up">
            <div class="w-20 h-20 bg-gradient-to-br from-red-500/20 to-red-600/20 rounded-full flex items-center justify-center mx-auto mb-6 border-2 border-red-500/20">
                <i class="ph ph-trash text-3xl text-red-400"></i>
            </div>
            
            <h2 class="text-title text-primary mb-3">Konfirmasi Hapus Member</h2>
            <p class="text-body mb-2">Anda akan menghapus member:</p>
            <p class="text-lg font-semibold text-primary mb-4" id="delete-member-name"></p>
            <p class="text-body mb-8 text-red-400"> Data akan dihapus permanen dan tidak bisa dikembalikan!</p>
            
            <div class="flex gap-4">
                <button id="cancel-delete-btn" class="flex-1 btn-secondary">Batal</button>
                <button id="confirm-delete-btn" class="flex-1 btn-danger flex items-center justify-center gap-2">
                    <span id="delete-text">Ya, Hapus</span>
                    <div id="delete-spinner" class="w-5 h-5 border-2 border-white border-dashed rounded-full animate-spin hidden"></div>
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden Card Template for Rendering -->
    <div id="card-render-template" class="fixed -left-[9999px] top-0 w-[480px]">
         <div id="card-to-render" class="w-full text-white shadow-2xl card-bg aspect-4-3 flex flex-col p-8 border border-white/10 overflow-hidden">
             <div class="flex justify-between items-start mb-8">
                <div class="flex items-center gap-4">
                    <img src="logo.png" alt="Vinca Gym Logo" class="h-14 w-auto rounded-full">
                    <div>
                        <h1 class="font-bold text-2xl tracking-wide">Vinca Gym</h1>
                        <p class="text-xs text-gray-400 uppercase tracking-widest mt-1">move with us</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="font-semibold text-xs text-gray-400 uppercase tracking-[0.2em]">Membership</p>
                    <p class="font-bold text-xl text-amber-300 uppercase tracking-[0.1em] -mt-1">Card</p>
                </div>
            </div>
            <div class="flex-grow flex items-center justify-between gap-6">
                <div class="text-left">
                    <h2 id="render-member-name" class="text-3xl font-bold"></h2>
                    <p id="render-member-id" class="font-mono text-amber-300 mt-2 tracking-widest"></p>
                </div>
                <div id="render-qrcode" class="p-2 bg-white rounded-xl shadow-lg"></div>
            </div>
            <div class="text-center border-t border-white/10 pt-4 mt-4">
                <p class="text-xs font-semibold tracking-[0.3em] text-gray-500">FOR WOMEN ONLY</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, query, where, updateDoc, getDoc, setDoc, arrayUnion, runTransaction, documentId, writeBatch, Timestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- KONFIGURASI & INISIALISASI ---
            const firebaseConfig = { apiKey: "AIzaSyBJsVSa2KVdB7w3A-5c9i5MqcpdaqZ_lqQ", authDomain: "vinca-gym-website.firebaseapp.com", projectId: "vinca-gym-website", storageBucket: "vinca-gym-website.firebasestorage.app", messagingSenderId: "430179505282", appId: "1:430179505282:web:e7128a258fb64cebcb109b", measurementId: "G-5KVHK8RPK9" };
            const ADMIN_PASSWORD = "vincagym123";
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);

            // --- Variabel Global & Cache ---
            let allMemberData = [];
            let filteredMemberData = [];
            let allArchiveData = [];
            let filteredArchiveData = [];
            let html5QrCode;
            let currentReportData = null; // Cache for report data for export
            let memberToRestore = null; // Member yang akan dipulihkan
            let memberToDelete = null; // Member yang akan dihapus
            
            // --- Pagination variables ---
            let currentPage = 1;
            const itemsPerPage = 25

            // --- ELEMEN DOM ---
            const DOMElements = {
                loginSection: document.getElementById('login-section'),
                adminDashboard: document.getElementById('admin-dashboard'),
                loginForm: document.getElementById('login-form'),
                passwordInput: document.getElementById('password'),
                loginError: document.getElementById('login-error'),
                togglePassword: document.getElementById('toggle-password'),
                eyeIcon: document.getElementById('eye-icon'),
                navigation: {
                    showAttendanceBtn: document.getElementById('show-attendance-btn'),
                    showMembersBtn: document.getElementById('show-members-btn'),
                    showReportsBtn: document.getElementById('show-reports-btn'),
                    attendanceView: document.getElementById('attendance-view'),
                    membersView: document.getElementById('members-view'),
                    reportsView: document.getElementById('reports-view'), // BARU
                },
                summary: {
                    total: document.getElementById('total-pendaftar'),
                    paid: document.getElementById('sudah-bayar'),
                    unpaid: document.getElementById('belum-bayar')
                },
                attendance: {
                    startScanBtn: document.getElementById('start-scan-btn'),
                    scannerModal: document.getElementById('scanner-modal'),
                    stopScanBtn: document.getElementById('stop-scan-btn'),
                    reader: document.getElementById('reader'),
                    manualForm: document.getElementById('manual-checkin-form'),
                    manualInput: document.getElementById('manual-no-member'),
                    result: document.getElementById('checkin-result'),
                    historyContent: document.getElementById('attendance-history-content'),
                    exportBtn: document.getElementById('export-attendance-btn'),
                    startDateInput: document.getElementById('start-date'),
                    endDateInput: document.getElementById('end-date'),
                    exportMessage: document.getElementById('export-attendance-message'),
                    visitorForm: document.getElementById('visitor-form'),
                    visitorNameInput: document.getElementById('visitor-name'),
                    visitorWhatsappInput: document.getElementById('visitor-whatsapp'),
                    visitorResult: document.getElementById('visitor-result'),
                },
                members: {
                    tableView: document.getElementById('member-table-view'),
                    detailView: document.getElementById('member-detail-view'),
                    content: document.getElementById('member-content'),
                    searchInput: document.getElementById('search-member-input'),
                    exportBtn: document.getElementById('export-member-btn'),
                    archiveBtn: document.getElementById('archive-members-btn'),
                    archiveMessage: document.getElementById('archive-message'),
                    archiveConfirmModal: document.getElementById('archive-confirm-modal'),
                    confirmArchiveBtn: document.getElementById('confirm-archive-btn'),
                    cancelArchiveBtn: document.getElementById('cancel-archive-btn'),
                    archiveText: document.getElementById('archive-text'),
                    archiveSpinner: document.getElementById('archive-spinner'),
                },
                reports: {
                    periodTitle: document.getElementById('report-period-title'),
                    filterButtons: document.getElementById('report-filter-buttons'),
                    totalIncome: document.getElementById('report-total-income'),
                    memberIncome: document.getElementById('report-member-income'),
                    visitorIncome: document.getElementById('report-visitor-income'),
                    detailsContent: document.getElementById('report-details-content'),
                    exportBtn: document.getElementById('export-report-btn'),
                    monthSelect: document.getElementById('report-month-select'),
                    yearSelect: document.getElementById('report-year-select'),
                    startDateInput: document.getElementById('report-start-date'),
                    endDateInput: document.getElementById('report-end-date'),
                    applyCustomDateBtn: document.getElementById('report-apply-custom-date'),
                },
                memberTabs: {
                    activeTab: document.getElementById('tab-active-members'),
                    archiveTab: document.getElementById('tab-archive'),
                    activeContent: document.getElementById('active-members-tab'),
                    archiveContent: document.getElementById('archive-tab'),
                },
                archive: {
                    content: document.getElementById('archive-content'),
                    searchInput: document.getElementById('search-archive-input'),
                    messageDisplay: document.getElementById('archive-message-display'),
                    restoreModal: document.getElementById('restore-confirm-modal'),
                    confirmRestoreBtn: document.getElementById('confirm-restore-btn'),
                    cancelRestoreBtn: document.getElementById('cancel-restore-btn'),
                    restoreMemberName: document.getElementById('restore-member-name'),
                    restoreText: document.getElementById('restore-text'),
                    restoreSpinner: document.getElementById('restore-spinner'),
                },
                deleteMember: {
                    modal: document.getElementById('delete-confirm-modal'),
                    confirmBtn: document.getElementById('confirm-delete-btn'),
                    cancelBtn: document.getElementById('cancel-delete-btn'),
                    memberName: document.getElementById('delete-member-name'),
                    deleteText: document.getElementById('delete-text'),
                    deleteSpinner: document.getElementById('delete-spinner'),
                },
                pagination: {
                    container: document.getElementById('pagination-container'),
                    info: document.getElementById('pagination-info'),
                    controls: document.getElementById('pagination-controls')
                },
                cardTemplate: {
                    container: document.getElementById('card-to-render'),
                    name: document.getElementById('render-member-name'),
                    id: document.getElementById('render-member-id'),
                    qrcode: document.getElementById('render-qrcode')
                }
            };

            // Update current time display
            function updateTime() {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('id-ID', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                });
                const timeEl = document.getElementById('current-time');
                if (timeEl) timeEl.textContent = timeStr;
            }
            
            updateTime();
            setInterval(updateTime, 1000);

            // --- FUNGSI-FUNGSI ---

            // Fungsi Utilitas
            const formatRupiah = (angka) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka || 0);
            const formatDate = (timestamp) => (timestamp && timestamp.seconds) ? new Date(timestamp.seconds * 1000).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' }) : '-';
            const formatDateShort = (date) => date.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });
            
            // Fungsi untuk sort member berdasarkan nomor
            function sortMembersByCode(members) {
                return [...members].sort((a, b) => {
                    const codeA = a.kodePendaftaran || '';
                    const codeB = b.kodePendaftaran || '';
                    
                    // Extract prefix (R, S, G, P) dan nomor
                    const matchA = codeA.match(/VG-([RSGP])(\d+)/);
                    const matchB = codeB.match(/VG-([RSGP])(\d+)/);
                    
                    if (!matchA || !matchB) {
                        return codeA.localeCompare(codeB);
                    }
                    
                    const prefixA = matchA[1];
                    const prefixB = matchB[1];
                    const numberA = parseInt(matchA[2], 10);
                    const numberB = parseInt(matchB[2], 10);
                    
                    // Urutan prefix: R, S, G, P
                    const prefixOrder = { 'R': 1, 'S': 2, 'G': 3, 'P': 4 };
                    
                    // Bandingkan prefix dulu
                    if (prefixOrder[prefixA] !== prefixOrder[prefixB]) {
                        return prefixOrder[prefixA] - prefixOrder[prefixB];
                    }
                    
                    // Jika prefix sama, bandingkan nomor
                    return numberA - numberB;
                });
            }
            const formatDateForInput = (timestamp) => {
                if (!timestamp || !timestamp.seconds) return '';
                const date = new Date(timestamp.seconds * 1000);
                return date.toISOString().split('T')[0];
            };
             const formatDateForDocId = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            const formatTimeForInput = (timestamp) => {
                if (!timestamp || typeof timestamp.seconds !== 'number') return '';
                const date = new Date(timestamp.seconds * 1000 + (timestamp.nanoseconds / 1000000));
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${hours}:${minutes}`;
            };
            const parseTimeToDate = (timeString, datePart) => {
                if (!timeString) return null;
                const [hours, minutes] = timeString.split(':');
                const date = new Date(datePart);
                date.setHours(parseInt(hours, 10), parseInt(minutes, 10), 0, 0);
                return date;
            };
            const getTodayDocId = () => {
                const today = new Date();
                return formatDateForDocId(today);
            };
            function exportToExcel(filename, sheets) { // Diperbarui untuk multi-sheet
                const wb = XLSX.utils.book_new();
                sheets.forEach(sheet => {
                    const ws = XLSX.utils.json_to_sheet(sheet.data);
                    XLSX.utils.book_append_sheet(wb, ws, sheet.sheetName);
                });
                XLSX.writeFile(wb, filename);
            }

            // Fungsi Interaksi Firestore
            async function fetchDocument(collectionName, docId) {
                const docRef = doc(db, collectionName, docId);
                const docSnap = await getDoc(docRef);
                return docSnap.exists() ? { docId: docSnap.id, ...docSnap.data() } : null;
            }
            
            async function findMemberByCode(memberId) {
                 const q = query(collection(db, "pendaftaran_member"), where("kodePendaftaran", "==", memberId));
                 const querySnapshot = await getDocs(q);
                 if (querySnapshot.empty) return null;
                 const docRef = querySnapshot.docs[0];
                 return { docId: docRef.id, ...docRef.data() };
            }
            
            async function updateAttendanceEntry(entryId, newCheckinTime, newCheckoutTime) {
                const todayId = getTodayDocId();
                const attendanceDocRef = doc(db, "daily_attendance", todayId);
                try {
                    await runTransaction(db, async (transaction) => {
                        const attendanceDoc = await transaction.get(attendanceDocRef);
                        if (!attendanceDoc.exists()) throw "Document does not exist!";
                        
                        let entries = attendanceDoc.data().entries || [];
                        const entryIndex = entries.findIndex(e => e.id === entryId);

                        if (entryIndex > -1) {
                            const todayDatePart = new Date().toISOString().split('T')[0];
                            
                            if (document.getElementById(`checkin-${entryId}`) && !document.getElementById(`checkin-${entryId}`).disabled) {
                                const checkinDate = parseTimeToDate(newCheckinTime, todayDatePart);
                                if (checkinDate) entries[entryIndex].waktuCheckin = checkinDate;
                            }
                            
                            const checkoutDate = parseTimeToDate(newCheckoutTime, todayDatePart);
                            entries[entryIndex].waktuCheckout = checkoutDate; 
                            
                            transaction.set(attendanceDocRef, { entries: entries });
                        }
                    });
                    showAttendanceResult('update_success');
                    loadAttendanceHistory();
                } catch (e) {
                    console.error("Transaction failed: ", e);
                    showAttendanceResult('error');
                }
            }
            
            async function downloadMemberCard(member) {
                DOMElements.cardTemplate.name.textContent = member.nama || 'Nama Member';
                DOMElements.cardTemplate.id.textContent = member.kodePendaftaran || 'VG-XXXX';
                
                const qrcodeContainer = DOMElements.cardTemplate.qrcode;
                qrcodeContainer.innerHTML = "";
                new QRCode(qrcodeContainer, {
                    text: member.kodePendaftaran || "N/A",
                    width: 80,
                    height: 80,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H
                });

                try {
                    setTimeout(async () => {
                        const canvas = await html2canvas(DOMElements.cardTemplate.container, {useCORS: true, backgroundColor: null});
                        const link = document.createElement('a');
                        link.download = `kartu-member-${member.kodePendaftaran}.png`;
                        link.href = canvas.toDataURL();
                        link.click();
                    }, 500);
                } catch (error) {
                    console.error('Gagal mengunduh kartu:', error);
                    alert('Gagal mengunduh kartu member.');
                }
            }

            // --- PAGINATION FUNCTIONS ---
            function getPaginatedData(data, page, itemsPerPage) {
                const startIndex = (page - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                return data.slice(startIndex, endIndex);
            }

            function getTotalPages(dataLength, itemsPerPage) {
                return Math.ceil(dataLength / itemsPerPage);
            }

            function renderPaginationControls(totalItems, currentPage, itemsPerPage) {
                const totalPages = getTotalPages(totalItems, itemsPerPage);
                const startItem = totalItems === 0 ? 0 : (currentPage - 1) * itemsPerPage + 1;
                const endItem = Math.min(currentPage * itemsPerPage, totalItems);
                
                // Update info
                DOMElements.pagination.info.textContent = `Menampilkan ${startItem}-${endItem} dari ${totalItems} data`;
                
                // Clear controls
                DOMElements.pagination.controls.innerHTML = '';
                
                if (totalPages <= 1) {
                    DOMElements.pagination.container.classList.add('hidden');
                    return;
                }
                
                DOMElements.pagination.container.classList.remove('hidden');
                
                // Previous button
                const prevBtn = document.createElement('button');
                prevBtn.className = 'pagination-btn';
                prevBtn.innerHTML = '<i class="ph ph-caret-left"></i>';
                prevBtn.disabled = currentPage === 1;
                prevBtn.onclick = () => goToPage(currentPage - 1);
                DOMElements.pagination.controls.appendChild(prevBtn);
                
                // Page numbers
                const startPage = Math.max(1, currentPage - 2);
                const endPage = Math.min(totalPages, currentPage + 2);
                
                if (startPage > 1) {
                    const firstBtn = document.createElement('button');
                    firstBtn.className = 'pagination-btn';
                    firstBtn.textContent = '1';
                    firstBtn.onclick = () => goToPage(1);
                    DOMElements.pagination.controls.appendChild(firstBtn);
                    
                    if (startPage > 2) {
                        const dots = document.createElement('span');
                        dots.className = 'pagination-btn';
                        dots.textContent = '...';
                        dots.style.cursor = 'default';
                        DOMElements.pagination.controls.appendChild(dots);
                    }
                }
                
                for (let i = startPage; i <= endPage; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
                    pageBtn.textContent = i;
                    pageBtn.onclick = () => goToPage(i);
                    DOMElements.pagination.controls.appendChild(pageBtn);
                }
                
                if (endPage < totalPages) {
                    if (endPage < totalPages - 1) {
                        const dots = document.createElement('span');
                        dots.className = 'pagination-btn';
                        dots.textContent = '...';
                        dots.style.cursor = 'default';
                        DOMElements.pagination.controls.appendChild(dots);
                    }
                    
                    const lastBtn = document.createElement('button');
                    lastBtn.className = 'pagination-btn';
                    lastBtn.textContent = totalPages;
                    lastBtn.onclick = () => goToPage(totalPages);
                    DOMElements.pagination.controls.appendChild(lastBtn);
                }
                
                // Next button
                const nextBtn = document.createElement('button');
                nextBtn.className = 'pagination-btn';
                nextBtn.innerHTML = '<i class="ph ph-caret-right"></i>';
                nextBtn.disabled = currentPage === totalPages;
                nextBtn.onclick = () => goToPage(currentPage + 1);
                DOMElements.pagination.controls.appendChild(nextBtn);
            }

            function goToPage(page) {
                const totalPages = getTotalPages(filteredMemberData.length, itemsPerPage);
                if (page < 1 || page > totalPages) return;
                
                currentPage = page;
                renderMemberTable(filteredMemberData);
            }

            // --- FUNGSI RENDER (Update UI) ---
            function renderMemberTable(membersToRender = allMemberData) {
                // Update filtered data
                filteredMemberData = membersToRender;
                
                // Reset to first page if current page is out of bounds
                const totalPages = getTotalPages(filteredMemberData.length, itemsPerPage);
                if (currentPage > totalPages && totalPages > 0) {
                    currentPage = 1;
                }
                
                // Get paginated data
                const paginatedData = getPaginatedData(filteredMemberData, currentPage, itemsPerPage);
                
                let tableHtml = `<div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-gray-700/50"><tr><th class="py-2 px-4">No</th><th class="py-2 px-4">No. Member</th><th class="py-2 px-4">Nama Lengkap</th><th class="py-2 px-4">Paket</th><th class="py-2 px-4">Tanggal Selesai</th><th class="py-2 px-4">Status Bayar</th><th class="py-2 px-4">Aksi</th></tr></thead><tbody>`;
                
                if (paginatedData.length > 0) {
                    // Data sudah terurut dari sortMembersByCode, tidak perlu sort lagi
                    paginatedData.forEach((member, index) => {
                        const isPaid = member.statusPembayaran === true;
                        const globalIndex = (currentPage - 1) * itemsPerPage + index + 1;
                        
                        let rowClass = '';
                        if (!isPaid) {
                            rowClass = 'unpaid-row';
                        } else {
                            const now = new Date();
                            const expiryDate = member.tanggalSelesai.toDate();
                            const timeDiff = expiryDate.getTime() - now.getTime();
                            const dayDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));

                            if (dayDiff >= 0 && dayDiff <= 1) { 
                                rowClass = 'expiring-row';
                            }
                        }

                        tableHtml += `
                            <tr class="border-b border-gray-700 text-sm ${rowClass}" data-doc-id="${member.docId}">
                                <td class="py-2 px-4 font-medium text-gray-400">${globalIndex}</td>
                                <td class="py-2 px-4 font-mono member-row">${member.kodePendaftaran || '-'}</td>
                                <td class="py-2 px-4 member-row">${member.nama || 'N/A'}</td>
                                <td class="py-2 px-4 member-row">${member.paket || 'N/A'}</td>
                                <td class="py-2 px-4 member-row">${formatDate(member.tanggalSelesai)}</td>
                                <td class="py-2 px-4 member-row">${isPaid ? '<span class="text-green-400">Lunas</span>' : '<span class="text-red-400">Belum Lunas</span>'}</td>
                                <td class="py-2 px-4">
                                    <button class="delete-member-btn text-red-400 hover:text-red-300 p-2" data-doc-id="${member.docId}" data-member-name="${member.nama}" title="Hapus Member">
                                        <i class="ph ph-trash text-lg"></i>
                                    </button>
                                </td>
                            </tr>`;
                    });
                } else {
                    tableHtml += `<tr><td colspan="7" class="text-center py-4 text-gray-400">Tidak ada member yang cocok.</td></tr>`;
                }
                tableHtml += `</tbody></table></div>`;
                DOMElements.members.content.innerHTML = tableHtml;

                // Render pagination
                renderPaginationControls(filteredMemberData.length, currentPage, itemsPerPage);

                // Add click event listeners to member rows
                document.querySelectorAll('.member-row').forEach(row => {
                    row.addEventListener('click', (e) => {
                        const docId = e.currentTarget.closest('tr').dataset.docId;
                        showMemberDetail(docId, 'view');
                    });
                });
                
                // Add click event listeners to delete buttons
                document.querySelectorAll('.delete-member-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent row click
                        const docId = e.currentTarget.dataset.docId;
                        const memberName = e.currentTarget.dataset.memberName;
                        showDeleteConfirmation(docId, memberName);
                    });
                });
            }

            function showMemberDetail(docId, mode = 'view') {
                const member = allMemberData.find(m => m.docId === docId);
                if (!member) return;

                const isPaid = member.statusPembayaran === true;
                
                let detailHtml = '';
                if (mode === 'edit') {
                    detailHtml = `
                        <div class="card p-8">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-white">Edit Data: ${member.nama}</h2>
                                <div id="detail-message" class="text-sm"></div>
                            </div>
                            <div class="space-y-4">
                                <div><label for="detail-nama" class="block text-xs font-medium text-gray-400">Nama Lengkap</label><input type="text" id="detail-nama" class="w-full mt-1" value="${member.nama}"></div>
                                <div><label for="detail-dob" class="block text-xs font-medium text-gray-400">Tanggal Lahir</label><input type="date" id="detail-dob" class="w-full mt-1" value="${formatDateForInput(member.tanggalLahir)}"></div>
                                <div><label for="detail-whatsapp" class="block text-xs font-medium text-gray-400">No. WhatsApp (+62)</label><input type="tel" id="detail-whatsapp" class="w-full mt-1" value="${(member.whatsapp || '').replace('62', '')}"></div>
                                <div><label for="detail-email" class="block text-xs font-medium text-gray-400">Email</label><input type="email" id="detail-email" class="w-full mt-1" value="${member.email || ''}"></div>
                                <div><label for="detail-alamat" class="block text-xs font-medium text-gray-400">Alamat</label><textarea id="detail-alamat" rows="2" class="w-full mt-1">${member.alamat}</textarea></div>
                                <hr class="border-gray-700 my-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label for="detail-start-date" class="block text-xs font-medium text-gray-400">Tanggal Mulai</label><input type="date" id="detail-start-date" class="w-full mt-1" value="${formatDateForInput(member.tanggalMulai)}"></div>
                                    <div><label for="detail-end-date" class="block text-xs font-medium text-gray-400">Tanggal Selesai</label><input type="date" id="detail-end-date" class="w-full mt-1" value="${formatDateForInput(member.tanggalSelesai)}"></div>
                                </div>
                                <div class="flex items-center gap-4 pt-2">
                                    <label for="payment-checkbox-detail" class="font-bold text-white">Status Lunas:</label>
                                    <input type="checkbox" id="payment-checkbox-detail" data-doc-id="${member.docId}" data-index="${member.index}" class="payment-checkbox-detail w-5 h-5" ${isPaid ? 'checked' : ''}>
                                </div>
                                <div class="flex gap-4 mt-6">
                                    <button id="cancel-edit-btn" class="w-full btn-secondary py-2 rounded-lg">Batal</button>
                                    <button id="save-member-changes-btn" class="w-full btn-primary py-2 rounded-lg">Simpan Perubahan</button>
                                </div>
                            </div>
                        </div>`;
                } else { // View Mode
                    const noWa = (member.whatsapp || '').replace(/\D/g, '');
                    const waLink = `https://wa.me/${noWa}`;
                    const displayWa = noWa ? `0${noWa.substring(2)}` : '-';
                    detailHtml = `
                        <div class="card p-8">
                            <div class="flex justify-between items-start">
                                <button id="back-to-table" class="mb-6 text-gray-400 hover:text-white flex items-center gap-2"><i class="ph ph-arrow-left"></i> Kembali</button>
                                <button id="edit-member-btn" class="text-gray-400 hover:text-white"><i class="ph ph-pencil-simple text-2xl"></i></button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="md:col-span-1">
                                    <h2 class="text-2xl font-bold text-white">${member.nama}</h2>
                                    <p class="font-mono text-yellow-400">${member.kodePendaftaran}</p>
                                    <div id="status-bayar-detail" class="mt-2 text-lg font-semibold ${isPaid ? 'text-green-400' : 'text-red-400'}">
                                        ${isPaid ? 'Lunas' : 'Belum Lunas'}
                                    </div>
                                </div>
                                <div class="md:col-span-2 space-y-3 text-sm">
                                    <p><strong class="text-gray-400 w-32 inline-block">Tanggal Lahir:</strong> ${formatDate(member.tanggalLahir)}</p>
                                    <p><strong class="text-gray-400 w-32 inline-block">No. WhatsApp:</strong> <a href="${waLink}" target="_blank" class="text-green-400 hover:underline">${displayWa}</a></p>
                                    <p><strong class="text-gray-400 w-32 inline-block">Email:</strong> ${member.email || '-'}</p>
                                    <p><strong class="text-gray-400 w-32 inline-block">Alamat:</strong> ${member.alamat}</p>
                                    <hr class="border-gray-700">
                                    <p><strong class="text-gray-400 w-32 inline-block">Paket:</strong> ${member.paket}</p>
                                    <p><strong class="text-gray-400 w-32 inline-block">Tanggal Mulai:</strong> ${formatDate(member.tanggalMulai)}</p>
                                    <p><strong class="text-gray-400 w-32 inline-block">Tanggal Selesai:</strong> ${formatDate(member.tanggalSelesai)}</p>
                                    <p><strong class="text-gray-400 w-32 inline-block">Total Bayar:</strong> ${formatRupiah(member.totalBayar)}</p>
                                    <div id="send-card-container" class="${isPaid ? '' : 'hidden'} pt-2 flex gap-2">
                                        <button id="download-card-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2 text-sm"><i class="ph ph-download-simple"></i>Unduh Kartu</button>
                                        <a id="send-whatsapp-btn" href="#" target="_blank" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2 text-sm"><i class="ph ph-whatsapp-logo"></i>Kirim Kartu via WA</a>
                                    </div>
                                    <hr class="border-gray-700 my-4">
                                    <div>
                                        <h4 class="font-bold text-white mb-2">Manajemen Cuti</h4>
                                        <p class="text-xs text-gray-400 mb-3">Tanggal selesai membership akan otomatis diperpanjang sesuai durasi cuti.</p>
                                        <form id="cuti-form" class="flex items-center gap-2">
                                            <input type="number" id="cuti-days" class="w-24 px-3 py-2" placeholder="Hari" min="1" required>
                                            <button type="submit" class="btn-secondary px-4 py-2 rounded-lg text-sm">Ajukan Cuti</button>
                                        </form>
                                        <div id="cuti-history" class="mt-4 text-xs">
                                            <p class="font-semibold text-gray-300">Riwayat Cuti:</p>
                                        </div>
                                    </div>
                                    
                                    <hr class="border-gray-700 my-4">
                                    <div>
                                        <h4 class="font-bold text-white mb-2"> Riwayat Kunjungan</h4>
                                        <p class="text-xs text-gray-400 mb-3">Histori check-in dan check-out member di gym</p>
                                        
                                        <!-- Statistik Kunjungan -->
                                        <div id="visit-stats" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                                            <div class="bg-gray-800/50 p-3 rounded-lg text-center">
                                                <p class="text-xs text-gray-400">Total</p>
                                                <p class="text-xl font-bold text-white" id="total-visits">-</p>
                                            </div>
                                            <div class="bg-gray-800/50 p-3 rounded-lg text-center">
                                                <p class="text-xs text-gray-400">Bulan Ini</p>
                                                <p class="text-xl font-bold text-green-400" id="month-visits">-</p>
                                            </div>
                                            <div class="bg-gray-800/50 p-3 rounded-lg text-center">
                                                <p class="text-xs text-gray-400">Minggu Ini</p>
                                                <p class="text-xl font-bold text-blue-400" id="week-visits">-</p>
                                            </div>
                                            <div class="bg-gray-800/50 p-3 rounded-lg text-center">
                                                <p class="text-xs text-gray-400">Rata-rata</p>
                                                <p class="text-xl font-bold text-purple-400" id="avg-visits">-</p>
                                            </div>
                                        </div>
                                        
                                        <!-- Tabel Riwayat -->
                                        <div id="visit-history" class="mt-4">
                                            <div class="flex items-center justify-center py-8">
                                                <p class="text-gray-400 text-sm">Memuat riwayat kunjungan...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                }
                
                DOMElements.members.detailView.innerHTML = detailHtml;
                DOMElements.members.tableView.classList.add('hidden');
                DOMElements.members.detailView.classList.remove('hidden');

                // Attach event listeners based on mode
                if (mode === 'edit') {
                    document.getElementById('save-member-changes-btn').addEventListener('click', () => handleUpdateMember(member.docId, member.index));
                    document.getElementById('cancel-edit-btn').addEventListener('click', () => showMemberDetail(docId, 'view'));
                    document.getElementById('payment-checkbox-detail').addEventListener('change', (e) => handlePaymentStatusChange(e));
                } else {
                    document.getElementById('back-to-table').addEventListener('click', () => {
                        DOMElements.members.detailView.classList.add('hidden');
                        DOMElements.members.tableView.classList.remove('hidden');
                        renderMemberTable(filteredMemberData); 
                    });
                    document.getElementById('edit-member-btn').addEventListener('click', () => showMemberDetail(docId, 'edit'));
                    if (isPaid) {
                        document.getElementById('download-card-btn').addEventListener('click', () => downloadMemberCard(member));
                        updateWhatsappLink(member);
                    }
                    const cutiForm = document.getElementById('cuti-form');
                    if (cutiForm) {
                        cutiForm.addEventListener('submit', (e) => handleCutiSubmit(e, member));
                    }
                    const cutiHistoryContainer = document.getElementById('cuti-history');
                    if (cutiHistoryContainer && member.riwayatCuti && member.riwayatCuti.length > 0) {
                        let historyHtml = '<ul class="list-disc list-inside mt-2 text-gray-400 space-y-1">';
                        member.riwayatCuti.forEach(cuti => {
                            historyHtml += `<li>Cuti <strong>${cuti.durasi} hari</strong>, mulai ${formatDate(cuti.tanggalMulai)}. Diperpanjang hingga ${formatDate(cuti.tanggalSelesaiDiperpanjangKe)}.</li>`;
                        });
                        historyHtml += '</ul>';
                        cutiHistoryContainer.innerHTML += historyHtml;
                    } else if (cutiHistoryContainer) {
                         cutiHistoryContainer.innerHTML += '<p class="text-gray-500 mt-2">Belum ada riwayat cuti.</p>';
                    }
                    
                    // Load riwayat kunjungan
                    loadMemberVisitHistory(member.kodePendaftaran);
                }
            }
            
            // Variables for visit history pagination
            let currentVisitPage = 1;
            const visitsPerPage = 15;
            let allMemberVisits = [];
            
            async function loadMemberVisitHistory(kodePendaftaran) {
                try {
                    const visitHistoryContainer = document.getElementById('visit-history');
                    if (!visitHistoryContainer) return;
                    
                    visitHistoryContainer.innerHTML = '<div class="flex items-center justify-center py-8"><p class="text-gray-400 text-sm">Memuat riwayat kunjungan...</p></div>';
                    
                    // Query all attendance records
                    const attendanceQuery = query(collection(db, "daily_attendance"));
                    const querySnapshot = await getDocs(attendanceQuery);
                    
                    // Filter entries for this member
                    allMemberVisits = [];
                    querySnapshot.forEach(doc => {
                        const date = doc.id;
                        const entries = doc.data().entries || [];
                        entries.forEach(entry => {
                            if (entry.type === 'Member' && entry.kodePendaftaran === kodePendaftaran) {
                                allMemberVisits.push({
                                    date: date,
                                    checkin: entry.waktuCheckin,
                                    checkout: entry.waktuCheckout,
                                    nama: entry.nama
                                });
                            }
                        });
                    });
                    
                    // Sort by date descending (newest first)
                    allMemberVisits.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    // Calculate statistics
                    const now = new Date();
                    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - now.getDay());
                    
                    const totalVisits = allMemberVisits.length;
                    const monthVisits = allMemberVisits.filter(v => new Date(v.date) >= startOfMonth).length;
                    const weekVisits = allMemberVisits.filter(v => new Date(v.date) >= startOfWeek).length;
                    
                    // Calculate average per week (based on total visits and weeks since first visit)
                    let avgVisits = 0;
                    if (allMemberVisits.length > 0) {
                        const firstVisit = new Date(allMemberVisits[allMemberVisits.length - 1].date);
                        const daysSinceFirst = Math.floor((now - firstVisit) / (1000 * 60 * 60 * 24));
                        const weeksSinceFirst = Math.max(1, Math.floor(daysSinceFirst / 7));
                        avgVisits = (totalVisits / weeksSinceFirst).toFixed(1);
                    }
                    
                    // Update statistics
                    document.getElementById('total-visits').textContent = totalVisits + 'x';
                    document.getElementById('month-visits').textContent = monthVisits + 'x';
                    document.getElementById('week-visits').textContent = weekVisits + 'x';
                    document.getElementById('avg-visits').textContent = avgVisits + 'x/minggu';
                    
                    // Reset to first page
                    currentVisitPage = 1;
                    
                    // Render table with pagination
                    renderVisitHistoryTable();
                    
                } catch (error) {
                    console.error("Error loading visit history:", error);
                    const visitHistoryContainer = document.getElementById('visit-history');
                    if (visitHistoryContainer) {
                        visitHistoryContainer.innerHTML = `<p class="text-red-400 text-sm text-center py-4">Gagal memuat riwayat kunjungan</p>`;
                    }
                }
            }
            
            function renderVisitHistoryTable() {
                const visitHistoryContainer = document.getElementById('visit-history');
                if (!visitHistoryContainer) return;
                
                if (allMemberVisits.length === 0) {
                    visitHistoryContainer.innerHTML = `
                        <div class="text-center py-8">
                            <div class="w-16 h-16 bg-gray-700/30 rounded-xl flex items-center justify-center mx-auto mb-3">
                                <i class="ph ph-calendar-x text-2xl text-gray-500"></i>
                            </div>
                            <p class="text-gray-400 text-sm">Belum ada riwayat kunjungan</p>
                        </div>`;
                    return;
                }
                
                // Calculate pagination
                const totalPages = Math.ceil(allMemberVisits.length / visitsPerPage);
                const startIndex = (currentVisitPage - 1) * visitsPerPage;
                const endIndex = startIndex + visitsPerPage;
                const visitsToShow = allMemberVisits.slice(startIndex, endIndex);
                
                let tableHtml = `
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-700/50">
                                <tr>
                                    <th class="py-2 px-3">No</th>
                                    <th class="py-2 px-3">Tanggal</th>
                                    <th class="py-2 px-3">Check-in</th>
                                    <th class="py-2 px-3">Check-out</th>
                                    <th class="py-2 px-3">Durasi</th>
                                    <th class="py-2 px-3">Status</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                visitsToShow.forEach((visit, index) => {
                    const visitDate = new Date(visit.date);
                    const checkinTime = visit.checkin ? new Date(visit.checkin.seconds * 1000) : null;
                    const checkoutTime = visit.checkout ? new Date(visit.checkout.seconds * 1000) : null;
                    
                    const dateStr = visitDate.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
                    const checkinStr = checkinTime ? checkinTime.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '-';
                    const checkoutStr = checkoutTime ? checkoutTime.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '-';
                    
                    let duration = '-';
                    let statusBadge = '<span class="text-yellow-400">Ongoing</span>';
                    
                    if (checkinTime && checkoutTime) {
                        const durationMs = checkoutTime - checkinTime;
                        const hours = Math.floor(durationMs / (1000 * 60 * 60));
                        const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
                        duration = `${hours}j ${minutes}m`;
                        statusBadge = '<span class="text-green-400">Selesai</span>';
                    }
                    
                    tableHtml += `
                        <tr class="border-b border-gray-700 hover:bg-gray-800/30">
                            <td class="py-2 px-3 text-gray-400">${startIndex + index + 1}</td>
                            <td class="py-2 px-3">${dateStr}</td>
                            <td class="py-2 px-3">${checkinStr}</td>
                            <td class="py-2 px-3">${checkoutStr}</td>
                            <td class="py-2 px-3">${duration}</td>
                            <td class="py-2 px-3">${statusBadge}</td>
                        </tr>`;
                });
                
                tableHtml += `
                            </tbody>
                        </table>
                    </div>`;
                
                // Add pagination controls
                if (totalPages > 1) {
                    tableHtml += `
                        <div class="flex items-center justify-between mt-4 pt-4 border-t border-gray-700">
                            <div class="text-xs text-gray-400">
                                Menampilkan ${startIndex + 1}-${Math.min(endIndex, allMemberVisits.length)} dari ${allMemberVisits.length} kunjungan
                            </div>
                            <div class="flex gap-2">
                                <button id="visit-prev-btn" class="pagination-btn ${currentVisitPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentVisitPage === 1 ? 'disabled' : ''}>
                                    <i class="ph ph-caret-left"></i>
                                </button>
                                <span class="text-sm text-gray-300 px-3 py-1">
                                    ${currentVisitPage} / ${totalPages}
                                </span>
                                <button id="visit-next-btn" class="pagination-btn ${currentVisitPage === totalPages ? 'opacity-50 cursor-not-allowed' : ''}" ${currentVisitPage === totalPages ? 'disabled' : ''}>
                                    <i class="ph ph-caret-right"></i>
                                </button>
                            </div>
                        </div>`;
                }
                
                visitHistoryContainer.innerHTML = tableHtml;
                
                // Add event listeners for pagination
                if (totalPages > 1) {
                    const prevBtn = document.getElementById('visit-prev-btn');
                    const nextBtn = document.getElementById('visit-next-btn');
                    
                    if (prevBtn) {
                        prevBtn.addEventListener('click', () => {
                            if (currentVisitPage > 1) {
                                currentVisitPage--;
                                renderVisitHistoryTable();
                            }
                        });
                    }
                    
                    if (nextBtn) {
                        nextBtn.addEventListener('click', () => {
                            if (currentVisitPage < totalPages) {
                                currentVisitPage++;
                                renderVisitHistoryTable();
                            }
                        });
                    }
                }
            }
            
            function updateWhatsappLink(member) {
                const waButton = document.getElementById('send-whatsapp-btn');
                if (waButton) {
                    const noWa = (member.whatsapp || '').replace(/\D/g, '');
                    const message = `Ahlan *${member.nama}*, Jazakillahu khayraa telah menjadi member Vinca Gym. Anda Berada Pada Paket Membership *${member.paket}* dengan Tgl Expired : *${formatDate(member.tanggalSelesai)}*.\n\nSimpan Kartu Virtual untuk melakukan checkin\n\nPastikan keanggotaan member Vinca Gym kamu aktif agar dapat terus melakukan latihan. Baraakallahu Fiikum.\n\nPesan ini dikirim oleh *Vinca Gym*.\nJl. Bratasena IX Blok U7/41, Pamulang. Tangerang Selatan\nContact Person : 085782919391`;
                    waButton.href = `https://wa.me/${noWa}?text=${encodeURIComponent(message)}`;
                }
            }

            function updateSummary() {
                const total = allMemberData.length;
                const paid = allMemberData.filter(m => m.statusPembayaran === true).length;
                const unpaid = total - paid;
                DOMElements.summary.total.textContent = total;
                DOMElements.summary.paid.textContent = paid;
                DOMElements.summary.unpaid.textContent = unpaid;
            }

            async function handlePaymentStatusChange(event) {
                const checkbox = event.target;
                const docId = checkbox.dataset.docId;
                const index = checkbox.dataset.index;
                const isChecked = checkbox.checked;

                try {
                    const memberRef = doc(db, "pendaftaran_member", docId);
                    await updateDoc(memberRef, { statusPembayaran: isChecked });
                    
                    const memberIndex = allMemberData.findIndex(m => m.docId === docId);
                    if (memberIndex !== -1) {
                        allMemberData[memberIndex].statusPembayaran = isChecked;
                    }
                    updateSummary();
                } catch (error) {
                    console.error("Gagal update status pembayaran:", error);
                    alert("Gagal memperbarui status. Coba lagi.");
                    checkbox.checked = !isChecked;
                }
            }
            
            async function loadAttendanceHistory() {
                const historyContent = DOMElements.attendance.historyContent;
                historyContent.innerHTML = `<p>Memuat riwayat absensi...</p>`;
                try {
                    const todayId = getTodayDocId();
                    const docData = await fetchDocument("daily_attendance", todayId);
                    let attendanceData = docData ? docData.entries : [];

                    if (attendanceData && attendanceData.length > 0) {
                        attendanceData.sort((a, b) => (b.waktuCheckin?.seconds || 0) - (a.waktuCheckin?.seconds || 0));
                    }

                    let tableHtml = `<div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-gray-700/50"><tr><th class="py-2 px-4">No</th><th class="py-2 px-4">Nama</th><th class="py-2 px-4">Keterangan</th><th class="py-2 px-4">Jam Masuk</th><th class="py-2 px-4">Jam Keluar</th><th class="py-2 px-4">Aksi</th></tr></thead><tbody>`;
                    if (attendanceData && attendanceData.length > 0) {
                        attendanceData.forEach((entry, index) => {
                            const checkinTimeValue = formatTimeForInput(entry.waktuCheckin);
                            const checkoutTimeValue = formatTimeForInput(entry.waktuCheckout);
                            
                            tableHtml += `
                                <tr class="border-b border-gray-700 text-sm align-middle">
                                    <td class="py-2 px-4 font-medium text-gray-400">${index + 1}</td>
                                    <td class="py-2 px-4">${entry.nama}</td>
                                    <td class="py-2 px-4">${entry.type === 'Member' ? `<span class="font-mono">${entry.kodePendaftaran}</span>` : '<span class="text-blue-400">Visitor</span>'}</td>
                                    <td class="py-2 px-4"><input type="time" id="checkin-${entry.id}" class="w-full px-3 py-2" value="${checkinTimeValue}" ${entry.type === 'Visitor' ? 'disabled' : ''}></td>
                                    <td class="py-2 px-4"><input type="time" id="checkout-${entry.id}" class="w-full px-3 py-2" value="${checkoutTimeValue}"></td>
                                    <td class="py-2 px-4"><button data-entry-id="${entry.id}" class="save-time-btn btn-secondary text-xs py-1 px-3 rounded-md">Simpan</button></td>
                                </tr>`;
                        });
                    } else {
                        tableHtml += `<tr><td colspan="6" class="text-center py-4 text-gray-400">Belum ada aktivitas absensi hari ini.</td></tr>`;
                    }
                    tableHtml += `</tbody></table></div>`;
                    historyContent.innerHTML = tableHtml;
                    
                    document.querySelectorAll('.save-time-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const entryId = parseInt(e.target.dataset.entryId);
                            const newCheckin = document.getElementById(`checkin-${entryId}`).value;
                            const newCheckout = document.getElementById(`checkout-${entryId}`).value;
                            updateAttendanceEntry(entryId, newCheckin, newCheckout);
                        });
                    });

                } catch (error) {
                    console.error("Error loading attendance history: ", error);
                    historyContent.innerHTML = `<p class="text-red-500">Gagal memuat riwayat absensi.</p>`;
                }
            }

            async function handleMemberAttendance(memberId) {
                memberId = memberId.trim(); // Membersihkan spasi
                DOMElements.attendance.result.innerHTML = `<p>Memproses ${memberId}...</p>`;
                try {
                    const memberData = await findMemberByCode(memberId);

                    if (!memberData) {
                        showAttendanceResult('notfound', {id: memberId});
                        return;
                    }
                    
                    const todayId = getTodayDocId();
                    const attendanceDocRef = doc(db, "daily_attendance", todayId);
                    
                    await runTransaction(db, async (transaction) => {
                        const attendanceDoc = await transaction.get(attendanceDocRef);
                        let entries = attendanceDoc.exists() ? attendanceDoc.data().entries || [] : [];

                        const openCheckinIndex = entries.findIndex(
                            entry => entry.type === 'Member' && entry.kodePendaftaran === memberId && entry.waktuCheckout === null
                        );

                        if (openCheckinIndex > -1) {
                            entries[openCheckinIndex].waktuCheckout = new Date();
                            transaction.set(attendanceDocRef, { entries: entries }, { merge: true });
                            showAttendanceResult('checkout_success', memberData);
                        } else {
                            const now = new Date();
                            if (!memberData.tanggalSelesai || !memberData.tanggalSelesai.seconds) {
                                showAttendanceResult('error', { nama: memberData.nama, message: 'Data tanggal selesai tidak valid.' });
                                return;
                            }
                            const tanggalSelesai = new Date(memberData.tanggalSelesai.seconds * 1000);

                            if (memberData.statusPembayaran === false) {
                                showAttendanceResult('unpaid', memberData);
                                return;
                            }
                            if (now > tanggalSelesai) {
                                showAttendanceResult('expired', memberData);
                                return;
                            }

                            const newEntry = {
                                id: Date.now(),
                                type: 'Member',
                                kodePendaftaran: memberData.kodePendaftaran,
                                nama: memberData.nama,
                                waktuCheckin: new Date(),
                                waktuCheckout: null
                            };
                            
                            if (attendanceDoc.exists()) {
                                transaction.update(attendanceDocRef, { entries: arrayUnion(newEntry) });
                            } else {
                                transaction.set(attendanceDocRef, { entries: [newEntry] });
                            }
                            showAttendanceResult('checkin_success', memberData);
                        }
                    });
                    
                    loadAttendanceHistory();

                } catch (error) {
                    console.error("Error during member attendance processing: ", error);
                    showAttendanceResult('error');
                }
            }
            
            function showAttendanceResult(type, data = {}) {
                let resultHtml = '';
                const resultContainer = data.isVisitor ? DOMElements.attendance.visitorResult : DOMElements.attendance.result;
                
                switch(type) {
                    case 'checkin_success':
                        resultHtml = `<div class="bg-green-900/50 border border-green-500 text-green-300 p-4 rounded-lg"><strong>Check-in Berhasil:</strong> ${data.nama} (Aktif s/d ${formatDate(data.tanggalSelesai)})</div>`;
                        break;
                    case 'checkout_success':
                        resultHtml = `<div class="bg-blue-900/50 border border-blue-500 text-blue-300 p-4 rounded-lg"><strong>Check-out Berhasil:</strong> Sampai jumpa lagi, ${data.nama}!</div>`;
                        break;
                    case 'visitor_success':
                        resultHtml = `<div class="bg-green-900/50 border border-green-500 text-green-300 p-4 rounded-lg"><strong>Sukses:</strong> Pengunjung ${data.nama} berhasil dicatat.</div>`;
                        break;
                    case 'update_success':
                         resultHtml = `<div class="bg-green-900/50 border border-green-500 text-green-300 p-4 rounded-lg"><strong>Sukses:</strong> Waktu absensi berhasil diperbarui.</div>`;
                        break;
                    case 'expired':
                        resultHtml = `<div class="bg-yellow-900/50 border border-yellow-500 text-yellow-300 p-4 rounded-lg"><strong>Membership Kedaluwarsa:</strong> ${data.nama} (Berakhir pada ${formatDate(data.tanggalSelesai)})</div>`;
                        break;
                    case 'unpaid':
                        resultHtml = `<div class="bg-red-900/50 border border-red-500 text-red-300 p-4 rounded-lg"><strong>Pembayaran Belum Lunas:</strong> ${data.nama}</div>`;
                        break;
                    case 'notfound':
                        resultHtml = `<div class="bg-red-900/50 border border-red-500 text-red-300 p-4 rounded-lg"><strong>Error:</strong> No. Member "${data.id}" tidak ditemukan.</div>`;
                        break;
                    case 'error':
                        let errorMessage = data.message || "Terjadi kesalahan sistem.";
                        resultHtml = `<div class="bg-red-900/50 border border-red-500 text-red-300 p-4 rounded-lg"><strong>Error:</strong> ${errorMessage}</div>`;
                        break;
                }
                resultContainer.innerHTML = resultHtml;
                setTimeout(() => { resultContainer.innerHTML = ''; }, 6000);
            }

            async function loadMemberData() {
                try {
                    const querySnapshot = await getDocs(collection(db, "pendaftaran_member"));
                    allMemberData = querySnapshot.docs
                        .map((doc, index) => ({ docId: doc.id, index, ...doc.data() }))
                        .filter(member => member.isArchived !== true);
                    
                    // Sort berdasarkan nomor member menggunakan fungsi sortMembersByCode
                    allMemberData = sortMembersByCode(allMemberData);
                    
                    // Reset current page when loading new data
                    currentPage = 1;
                    
                    updateSummary();
                    renderMemberTable();
                } catch (error) {
                    console.error("Error loading member data: ", error);
                    DOMElements.members.content.innerHTML = `<p class="text-red-500">Gagal memuat data pendaftar.</p>`;
                }
            }
            
            async function handleVisitorSubmit(e) {
                e.preventDefault();
                const name = DOMElements.attendance.visitorNameInput.value.trim();
                const whatsapp = DOMElements.attendance.visitorWhatsappInput.value.trim();

                if (!name) {
                    showAttendanceResult('error', { isVisitor: true, message: 'Nama pengunjung tidak boleh kosong.' });
                    return;
                }

                const todayId = getTodayDocId();
                const attendanceDocRef = doc(db, "daily_attendance", todayId);

                const newVisitorEntry = {
                    id: Date.now(),
                    type: 'Pengunjung',
                    nama: name,
                    whatsapp: whatsapp,
                    waktuCheckin: new Date(),
                    waktuCheckout: null
                };

                try {
                    const docSnap = await getDoc(attendanceDocRef);
                    if (docSnap.exists()) {
                        await updateDoc(attendanceDocRef, {
                            entries: arrayUnion(newVisitorEntry)
                        });
                    } else {
                        await setDoc(attendanceDocRef, { entries: [newVisitorEntry] });
                    }

                    showAttendanceResult('visitor_success', { isVisitor: true, nama: name });
                    DOMElements.attendance.visitorForm.reset();
                    loadAttendanceHistory();
                } catch (error) {
                    console.error("Error saving visitor data:", error);
                    showAttendanceResult('error', { isVisitor: true, message: 'Gagal menyimpan data pengunjung.' });
                }
            }

            async function exportAttendanceHistory() {
                const startDate = DOMElements.attendance.startDateInput.value;
                const endDate = DOMElements.attendance.endDateInput.value;
                const msgEl = DOMElements.attendance.exportMessage;

                if (!startDate || !endDate) {
                    msgEl.textContent = 'Silakan pilih tanggal mulai dan tanggal selesai.';
                    msgEl.className = 'text-sm mt-4 text-red-400';
                    return;
                }

                if (new Date(startDate) > new Date(endDate)) {
                    msgEl.textContent = 'Tanggal mulai tidak boleh lebih besar dari tanggal selesai.';
                    msgEl.className = 'text-sm mt-4 text-red-400';
                    return;
                }

                msgEl.textContent = 'Memproses data...';
                msgEl.className = 'text-sm mt-4 text-yellow-400';

                try {
                    const q = query(collection(db, "daily_attendance"), 
                        where(documentId(), ">=", startDate), 
                        where(documentId(), "<=", endDate)
                    );

                    const querySnapshot = await getDocs(q);
                    if (querySnapshot.empty) {
                        msgEl.textContent = 'Tidak ada data absensi pada rentang tanggal yang dipilih.';
                        msgEl.className = 'text-sm mt-4 text-yellow-400';
                        return;
                    }

                    const dataForExport = [];
                    querySnapshot.forEach(doc => {
                        const date = doc.id;
                        const entries = doc.data().entries || [];
                        entries.forEach(entry => {
                            dataForExport.push({
                                'Tanggal': date,
                                'Nama': entry.nama,
                                'Keterangan': entry.type === 'Member' ? entry.kodePendaftaran : 'Pengunjung',
                                'No. WhatsApp': entry.whatsapp || '',
                                'Jam Masuk': entry.waktuCheckin ? formatTimeForInput(entry.waktuCheckin) : '',
                                'Jam Keluar': entry.waktuCheckout ? formatTimeForInput(entry.waktuCheckout) : ''
                            });
                        });
                    });
                    
                    dataForExport.sort((a,b) => new Date(a.Tanggal + ' ' + a['Jam Masuk']) - new Date(b.Tanggal + ' ' + b['Jam Masuk']));

                    if (dataForExport.length > 0) {
                        exportToExcel(`laporan_absensi_${startDate}_sd_${endDate}.xlsx`, [{ sheetName: 'Absensi', data: dataForExport }]);
                        msgEl.textContent = 'Laporan berhasil diunduh.';
                        msgEl.className = 'text-sm mt-4 text-green-400';
                    } else {
                        msgEl.textContent = 'Tidak ada data absensi pada rentang tanggal yang dipilih.';
                        msgEl.className = 'text-sm mt-4 text-yellow-400';
                    }
                } catch (error) {
                    console.error("Error exporting attendance history:", error);
                    msgEl.textContent = 'Gagal mengunduh laporan. Silakan coba lagi.';
                    msgEl.className = 'text-sm mt-4 text-red-400';
                }
            }

            async function archiveInactiveMembers() {
                const archiveBtn = DOMElements.members.confirmArchiveBtn;
                const archiveText = DOMElements.members.archiveText;
                const archiveSpinner = DOMElements.members.archiveSpinner;
                const archiveMessage = DOMElements.members.archiveMessage;

                archiveBtn.disabled = true;
                archiveText.textContent = 'Mengarsipkan...';
                archiveSpinner.classList.remove('hidden');
                archiveMessage.innerHTML = '';

                try {
                    // Hitung 3 bulan yang lalu
                    const today = new Date();
                    const threeMonthsAgo = new Date(today);
                    threeMonthsAgo.setMonth(today.getMonth() - 3);
                    threeMonthsAgo.setHours(0, 0, 0, 0);
                    
                    // Konversi ke Firestore Timestamp
                    const threeMonthsAgoTimestamp = Timestamp.fromDate(threeMonthsAgo);

                    const q = query(collection(db, "pendaftaran_member"), 
                        where("tanggalSelesai", "<", threeMonthsAgoTimestamp)
                    );
                    
                    const querySnapshot = await getDocs(q);
                    const membersToArchive = querySnapshot.docs.filter(doc => doc.data().isArchived !== true);

                    if (membersToArchive.length === 0) {
                        archiveMessage.innerHTML = `<div class="bg-blue-900/50 border border-blue-500 text-blue-300 p-3 rounded-lg text-sm">Tidak ada member tidak aktif yang perlu diarsipkan.</div>`;
                        return;
                    }

                    const batch = writeBatch(db);
                    let archivedCount = 0;

                    membersToArchive.forEach(docSnap => {
                        const memberRef = doc(db, "pendaftaran_member", docSnap.id);
                        const archiveRef = doc(db, "arsip_member", docSnap.id);
                        
                        const dataToArchive = docSnap.data();
                        batch.set(archiveRef, dataToArchive); // Copy to archive
                        batch.update(memberRef, { isArchived: true }); // Mark as archived
                        archivedCount++;
                    });

                    await batch.commit();
                    
                    archiveMessage.innerHTML = `<div class="bg-green-900/50 border border-green-500 text-green-300 p-3 rounded-lg text-sm"><strong>Berhasil:</strong> ${archivedCount} member telah diarsipkan.</div>`;
                    loadMemberData(); // Refresh the member list

                } catch (error) {
                    console.error("Error archiving members:", error);
                    archiveMessage.innerHTML = `<div class="bg-red-900/50 border border-red-500 text-red-300 p-3 rounded-lg text-sm"><strong>Gagal:</strong> Terjadi kesalahan saat mengarsipkan data.</div>`;
                } finally {
                    archiveBtn.disabled = false;
                    archiveText.textContent = 'Ya, Arsipkan';
                    archiveSpinner.classList.add('hidden');
                    DOMElements.members.archiveConfirmModal.classList.add('hidden');
                }
            }

            // --- FUNGSI RUANG ARSIP ---
            
            async function loadArchiveData() {
                try {
                    DOMElements.archive.content.innerHTML = `<div class="flex items-center justify-center py-12"><p class="text-body">Memuat data arsip...</p></div>`;
                    
                    const querySnapshot = await getDocs(collection(db, "arsip_member"));
                    allArchiveData = querySnapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() }));
                    
                    // Sort berdasarkan nomor member
                    allArchiveData = sortMembersByCode(allArchiveData);
                    
                    renderArchiveTable();
                } catch (error) {
                    console.error("Error loading archive data:", error);
                    DOMElements.archive.content.innerHTML = `<p class="text-red-500 text-center py-12">Gagal memuat data arsip.</p>`;
                }
            }
            
            function renderArchiveTable(archiveToRender = allArchiveData) {
                filteredArchiveData = archiveToRender;
                
                let tableHtml = `<div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-gray-700/50"><tr><th class="py-2 px-4">No</th><th class="py-2 px-4">No. Member</th><th class="py-2 px-4">Nama Lengkap</th><th class="py-2 px-4">Paket</th><th class="py-2 px-4">Tanggal Selesai</th><th class="py-2 px-4">Aksi</th></tr></thead><tbody>`;
                
                if (filteredArchiveData.length > 0) {
                    filteredArchiveData.forEach((member, index) => {
                        tableHtml += `
                            <tr class="border-b border-gray-700 text-sm hover:bg-gray-800/50">
                                <td class="py-2 px-4 font-medium text-gray-400">${index + 1}</td>
                                <td class="py-2 px-4 font-mono">${member.kodePendaftaran || '-'}</td>
                                <td class="py-2 px-4">${member.nama || 'N/A'}</td>
                                <td class="py-2 px-4">${member.paket || 'N/A'}</td>
                                <td class="py-2 px-4">${formatDate(member.tanggalSelesai)}</td>
                                <td class="py-2 px-4">
                                    <button class="restore-member-btn btn-success text-xs py-1 px-3" data-doc-id="${member.docId}" data-member-name="${member.nama}">
                                        <i class="ph ph-arrow-counter-clockwise"></i> Pulihkan
                                    </button>
                                </td>
                            </tr>`;
                    });
                } else {
                    tableHtml += `<tr><td colspan="6" class="text-center py-8 text-gray-400">Tidak ada member di arsip.</td></tr>`;
                }
                tableHtml += `</tbody></table></div>`;
                DOMElements.archive.content.innerHTML = tableHtml;
                
                // Add event listeners to restore buttons
                document.querySelectorAll('.restore-member-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const docId = e.currentTarget.dataset.docId;
                        const memberName = e.currentTarget.dataset.memberName;
                        showRestoreConfirmation(docId, memberName);
                    });
                });
            }
            
            function showRestoreConfirmation(docId, memberName) {
                memberToRestore = docId;
                DOMElements.archive.restoreMemberName.textContent = memberName;
                DOMElements.archive.restoreModal.classList.remove('hidden');
            }
            
            async function restoreMember() {
                if (!memberToRestore) return;
                
                const restoreBtn = DOMElements.archive.confirmRestoreBtn;
                const restoreText = DOMElements.archive.restoreText;
                const restoreSpinner = DOMElements.archive.restoreSpinner;
                const messageDisplay = DOMElements.archive.messageDisplay;
                
                restoreBtn.disabled = true;
                restoreText.textContent = 'Memulihkan...';
                restoreSpinner.classList.remove('hidden');
                messageDisplay.innerHTML = '';
                
                try {
                    const archiveRef = doc(db, "arsip_member", memberToRestore);
                    const memberRef = doc(db, "pendaftaran_member", memberToRestore);
                    
                    // Get archived data
                    const archiveDoc = await getDoc(archiveRef);
                    if (!archiveDoc.exists()) {
                        throw new Error("Data arsip tidak ditemukan");
                    }
                    
                    const memberData = archiveDoc.data();
                    
                    // Restore to active members
                    const batch = writeBatch(db);
                    batch.set(memberRef, { ...memberData, isArchived: false });
                    batch.delete(archiveRef);
                    await batch.commit();
                    
                    messageDisplay.innerHTML = `<div class="alert alert-success">Member berhasil dipulihkan ke daftar aktif!</div>`;
                    
                    // Reload data
                    await loadArchiveData();
                    await loadMemberData();
                    
                    setTimeout(() => {
                        messageDisplay.innerHTML = '';
                    }, 5000);
                    
                } catch (error) {
                    console.error("Error restoring member:", error);
                    messageDisplay.innerHTML = `<div class="alert alert-error">Gagal memulihkan member. Silakan coba lagi.</div>`;
                } finally {
                    restoreBtn.disabled = false;
                    restoreText.textContent = 'Ya, Pulihkan';
                    restoreSpinner.classList.add('hidden');
                    DOMElements.archive.restoreModal.classList.add('hidden');
                    memberToRestore = null;
                }
            }
            
            // --- FUNGSI DELETE MEMBER ---
            
            function showDeleteConfirmation(docId, memberName) {
                memberToDelete = docId;
                DOMElements.deleteMember.memberName.textContent = memberName;
                DOMElements.deleteMember.modal.classList.remove('hidden');
            }
            
            async function deleteMember() {
                if (!memberToDelete) return;
                
                const deleteBtn = DOMElements.deleteMember.confirmBtn;
                const deleteText = DOMElements.deleteMember.deleteText;
                const deleteSpinner = DOMElements.deleteMember.deleteSpinner;
                
                deleteBtn.disabled = true;
                deleteText.textContent = 'Menghapus...';
                deleteSpinner.classList.remove('hidden');
                
                try {
                    const memberRef = doc(db, "pendaftaran_member", memberToDelete);
                    
                    // Delete from Firestore
                    await deleteDoc(memberRef);
                    
                    // Remove from local array
                    allMemberData = allMemberData.filter(m => m.docId !== memberToDelete);
                    
                    // Show success message
                    alert('Member berhasil dihapus!');
                    
                    // Reload data and refresh table
                    await loadMemberData();
                    
                } catch (error) {
                    console.error("Error deleting member:", error);
                    alert('Gagal menghapus member. Silakan coba lagi.');
                } finally {
                    deleteBtn.disabled = false;
                    deleteText.textContent = 'Ya, Hapus';
                    deleteSpinner.classList.add('hidden');
                    DOMElements.deleteMember.modal.classList.add('hidden');
                    memberToDelete = null;
                }
            }

            async function handleCutiSubmit(e, member) {
                e.preventDefault();
                const cutiDaysInput = document.getElementById('cuti-days');
                const cutiDays = parseInt(cutiDaysInput.value, 10);

                if (isNaN(cutiDays) || cutiDays <= 0) {
                    alert("Jumlah hari cuti tidak valid.");
                    return;
                }

                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Memproses...';

                try {
                    const memberRef = doc(db, "pendaftaran_member", member.docId);
                    
                    await runTransaction(db, async (transaction) => {
                        const memberDoc = await transaction.get(memberRef);
                        if (!memberDoc.exists()) {
                            throw "Member tidak ditemukan!";
                        }

                        const memberData = memberDoc.data();
                        const currentTanggalSelesai = memberData.tanggalSelesai.toDate();
                        
                        const newTanggalSelesai = new Date(currentTanggalSelesai);
                        newTanggalSelesai.setDate(newTanggalSelesai.getDate() + cutiDays);

                        const newCutiRecord = {
                            tanggalMulai: new Date(),
                            durasi: cutiDays,
                            tanggalSelesaiDiperpanjangKe: newTanggalSelesai
                        };

                        const riwayatCuti = memberData.riwayatCuti || [];
                        riwayatCuti.push(newCutiRecord);

                        transaction.update(memberRef, {
                            tanggalSelesai: newTanggalSelesai,
                            riwayatCuti: riwayatCuti
                        });
                    });

                    alert(`Cuti berhasil diajukan. Tanggal selesai member diperpanjang.`);
                    
                    await loadMemberData();
                    const updatedMember = allMemberData.find(m => m.docId === member.docId);
                    if (updatedMember) {
                        showMemberDetail(updatedMember.docId);
                    }

                } catch (error) {
                    console.error("Gagal mengajukan cuti:", error);
                    alert("Terjadi kesalahan saat mengajukan cuti. Silakan coba lagi.");
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Ajukan Cuti';
                }
            }
            
            async function handleUpdateMember(docId, index) {
                const saveButton = document.getElementById('save-member-changes-btn');
                saveButton.disabled = true;
                saveButton.textContent = 'Menyimpan...';
                
                try {
                    const whatsappInput = document.getElementById('detail-whatsapp').value.replace(/\D/g, '');
                    const whatsappNumber = `62${whatsappInput.startsWith('0') ? whatsappInput.substring(1) : whatsappInput}`;

                    const updatedData = {
                        nama: document.getElementById('detail-nama').value,
                        tanggalLahir: new Date(document.getElementById('detail-dob').value),
                        whatsapp: whatsappNumber,
                        email: document.getElementById('detail-email').value,
                        alamat: document.getElementById('detail-alamat').value,
                        tanggalMulai: new Date(document.getElementById('detail-start-date').value),
                        tanggalSelesai: new Date(document.getElementById('detail-end-date').value),
                    };

                    const memberRef = doc(db, "pendaftaran_member", docId);
                    await updateDoc(memberRef, updatedData);
                    
                    const memberIndex = allMemberData.findIndex(m => m.docId === docId);
                    if(memberIndex !== -1) {
                       allMemberData[memberIndex] = { ...allMemberData[memberIndex], ...updatedData };
                    }

                    const msgEl = document.getElementById('detail-message');
                    msgEl.textContent = 'Data berhasil diperbarui!';
                    msgEl.className = 'text-sm text-green-400';
                    setTimeout(() => msgEl.textContent = '', 3000);
                    
                    loadMemberData(); // Refresh main table data in background
                    showMemberDetail(docId, 'view'); // Switch back to view mode

                } catch (error) {
                    console.error("Gagal update data member:", error);
                    const msgEl = document.getElementById('detail-message');
                    msgEl.textContent = 'Gagal menyimpan. Coba lagi.';
                    msgEl.className = 'text-sm text-red-400';
                    setTimeout(() => msgEl.textContent = '', 3000);
                } finally {
                    saveButton.disabled = false;
                    saveButton.textContent = 'Simpan Perubahan';
                }
            }

            // --- FUNGSI LAPORAN (BARU & DIPERBARUI) ---

            // Fungsi baru untuk mengambil data pendapatan pada rentang waktu tertentu
            async function fetchIncomeForPeriod(startDate, endDate) {
                let memberIncome = 0;
                let visitorIncome = 0;

                try {
                    // Ambil pendapatan member
                    const memberQuery = query(collection(db, "pendaftaran_member"),
                        where("tanggalMulai", ">=", startDate),
                        where("tanggalMulai", "<=", endDate)
                    );
                    const memberSnapshot = await getDocs(memberQuery);
                    memberSnapshot.docs
                        .filter(doc => doc.data().statusPembayaran === true)
                        .forEach(doc => {
                            memberIncome += doc.data().totalBayar || 0;
                        });

                    // Ambil pendapatan visitor
                    if (startDate.getTime() <= endDate.getTime()) {
                        const startDateId = formatDateForDocId(startDate);
                        const endDateId = formatDateForDocId(endDate);
                        
                        const visitorQuery = query(collection(db, "daily_attendance"),
                            where(documentId(), ">=", startDateId),
                            where(documentId(), "<=", endDateId)
                        );
                        const visitorSnapshot = await getDocs(visitorQuery);
                        
                        const PRICE_CHANGE_DATE = new Date('2025-09-15T00:00:00');
                        const VISITOR_PRICE_OLD = 25000;
                        const VISITOR_PRICE_NEW = 35000;

                        visitorSnapshot.forEach(doc => {
                            const visitDateStr = doc.id;
                            const visitDate = new Date(visitDateStr);
                             visitDate.setMinutes(visitDate.getMinutes() + visitDate.getTimezoneOffset());
                            const price = visitDate >= PRICE_CHANGE_DATE ? VISITOR_PRICE_NEW : VISITOR_PRICE_OLD;
                            
                            const entries = doc.data().entries || [];
                            visitorIncome += entries.filter(e => e.type === 'Pengunjung').length * price;
                        });
                    }
                } catch (e) {
                    console.error(`Error fetching income for ${startDate} to ${endDate}:`, e);
                    return { totalIncome: 0, memberIncome: 0, visitorIncome: 0 };
                }

                return { totalIncome: memberIncome + visitorIncome, memberIncome, visitorIncome };
            }

            function populateDateFilters() {
                const monthSelect = DOMElements.reports.monthSelect;
                const yearSelect = DOMElements.reports.yearSelect;
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth();

                const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
                monthSelect.innerHTML = '';
                months.forEach((month, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = month;
                    monthSelect.appendChild(option);
                });
                monthSelect.value = currentMonth;

                yearSelect.innerHTML = '';
                for (let i = currentYear; i >= 2024; i--) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    yearSelect.appendChild(option);
                }
                yearSelect.value = currentYear;
            }

            function setReportLoading(isLoading) {
                const content = DOMElements.reports.detailsContent;
                if (isLoading) {
                    content.innerHTML = `
                        <div class="flex items-center justify-center py-12">
                            <div class="text-center">
                                <div class="w-16 h-16 bg-gradient-to-br from-gray-500/20 to-gray-600/20 rounded-xl flex items-center justify-center mx-auto mb-4 animate-pulse">
                                    <i class="ph ph-chart-bar text-2xl text-gray-400"></i>
                                </div>
                                <p class="text-body">Menghitung pendapatan...</p>
                            </div>
                        </div>`;
                }
            }
            
            // Fungsi render UI laporan yang telah diperbarui
            function renderReportUI(data) {
                currentReportData = data;

                const { totalIncome, memberIncome, visitorIncome, growthRate, memberDetails, visitorDetails } = data;

                DOMElements.reports.totalIncome.textContent = formatRupiah(totalIncome);
                DOMElements.reports.memberIncome.textContent = formatRupiah(memberIncome);
                DOMElements.reports.visitorIncome.textContent = formatRupiah(visitorIncome);

                const growthRateEl = document.getElementById('report-growth-rate');
                const growthIconContainerEl = document.getElementById('report-growth-icon-container');
                const growthIconEl = document.getElementById('report-growth-icon');

                if (growthRateEl && growthIconContainerEl && growthIconEl) {
                    growthRateEl.textContent = `${growthRate.toFixed(1)}%`;
                    if (growthRate > 0) {
                        growthRateEl.className = 'text-3xl lg:text-4xl font-bold mt-2 text-green-300';
                        growthIconContainerEl.className = 'w-12 h-12 rounded-xl flex items-center justify-center bg-gradient-to-br from-green-500/20 to-green-600/20 border border-green-500/30';
                        growthIconEl.className = 'ph ph-trend-up text-2xl text-green-300';
                    } else if (growthRate < 0) {
                        growthRateEl.className = 'text-3xl lg:text-4xl font-bold mt-2 text-red-300';
                        growthIconContainerEl.className = 'w-12 h-12 rounded-xl flex items-center justify-center bg-gradient-to-br from-red-500/20 to-red-600/20 border border-red-500/30';
                        growthIconEl.className = 'ph ph-trend-down text-2xl text-red-300';
                    } else {
                        growthRateEl.className = 'text-3xl lg:text-4xl font-bold mt-2 text-text-secondary';
                        growthIconContainerEl.className = 'w-12 h-12 rounded-xl flex items-center justify-center bg-gradient-to-br from-gray-500/20 to-gray-600/20 border border-gray-500/30';
                        growthIconEl.className = 'ph ph-chart-line text-2xl text-text-secondary';
                    }
                }

                let detailsHtml = '';

                detailsHtml += `
                    <div class="bg-gradient-to-br from-blue-900/20 to-blue-800/10 border border-blue-500/30 rounded-2xl p-8 mb-8 backdrop-blur-sm">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-blue-500/30 to-blue-600/20 rounded-xl flex items-center justify-center">
                                    <i class="ph ph-users text-xl text-blue-400"></i>
                                </div>
                                <div>
                                    <h4 class="text-xl font-bold text-white mb-1">Pemasukan Member</h4>
                                    <p class="text-blue-200/70 text-sm">${memberDetails.length} transaksi ditemukan</p>
                                </div>
                            </div>
                            <div class="bg-blue-500/20 px-4 py-2 rounded-xl border border-blue-400/30">
                                <span class="text-blue-300 font-semibold">${formatRupiah(memberIncome)}</span>
                            </div>
                        </div>`;

                if (memberDetails.length > 0) {
                    detailsHtml += `
                        <div class="overflow-hidden rounded-xl border border-blue-500/20 bg-gray-900/50 backdrop-blur-sm">
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead class="bg-gradient-to-r from-blue-800/40 to-blue-900/40 border-b border-blue-500/30">
                                        <tr>
                                            <th class="py-4 px-6 text-blue-200 font-semibold text-sm">No</th>
                                            <th class="py-4 px-6 text-blue-200 font-semibold text-sm">Tanggal</th>
                                            <th class="py-4 px-6 text-blue-200 font-semibold text-sm">Nama Member</th>
                                            <th class="py-4 px-6 text-blue-200 font-semibold text-sm">No. Member</th>
                                            <th class="py-4 px-6 text-blue-200 font-semibold text-sm">Paket</th>
                                            <th class="py-4 px-6 text-blue-200 font-semibold text-sm text-right">Jumlah</th>
                                        </tr>
                                    </thead>
                                    <tbody id="member-table-body"></tbody>
                                </table>
                            </div>
                            <div class="border-t border-blue-500/20 bg-gray-900/30 px-6 py-4">
                                <div class="flex items-center justify-between">
                                    <div class="text-blue-200/70 text-sm" id="member-pagination-info"></div>
                                    <div class="flex items-center gap-2" id="member-pagination-controls"></div>
                                </div>
                            </div>
                        </div>
                    </div>`;
                } else {
                    detailsHtml += `
                            <div class="text-center py-12">
                                <div class="w-16 h-16 bg-blue-500/20 rounded-xl flex items-center justify-center mx-auto mb-4">
                                    <i class="ph ph-receipt text-2xl text-blue-400"></i>
                                </div>
                                <p class="text-blue-200/70">Tidak ada pemasukan dari member pada periode ini</p>
                            </div>
                        </div>`;
                }

                detailsHtml += `
                    <div class="bg-gradient-to-br from-green-900/20 to-green-800/10 border border-green-500/30 rounded-2xl p-8 backdrop-blur-sm">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-green-500/30 to-green-600/20 rounded-xl flex items-center justify-center">
                                    <i class="ph ph-user-plus text-xl text-green-400"></i>
                                </div>
                                <div>
                                    <h4 class="text-xl font-bold text-white mb-1">Pemasukan Visitor</h4>
                                    <p class="text-green-200/70 text-sm">${visitorDetails.length} kunjungan ditemukan</p>
                                </div>
                            </div>
                            <div class="bg-green-500/20 px-4 py-2 rounded-xl border border-green-400/30">
                                <span class="text-green-300 font-semibold">${formatRupiah(visitorIncome)}</span>
                            </div>
                        </div>`;

                if (visitorDetails.length > 0) {
                    detailsHtml += `
                        <div class="overflow-hidden rounded-xl border border-green-500/20 bg-gray-900/50 backdrop-blur-sm">
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead class="bg-gradient-to-r from-green-800/40 to-green-900/40 border-b border-green-500/30">
                                        <tr>
                                            <th class="py-4 px-6 text-green-200 font-semibold text-sm">No</th>
                                            <th class="py-4 px-6 text-green-200 font-semibold text-sm">Tanggal</th>
                                            <th class="py-4 px-6 text-green-200 font-semibold text-sm">Nama Pengunjung</th>
                                            <th class="py-4 px-6 text-green-200 font-semibold text-sm text-right">Jumlah</th>
                                        </tr>
                                    </thead>
                                    <tbody id="visitor-table-body"></tbody>
                                </table>
                            </div>
                            <div class="border-t border-green-500/20 bg-gray-900/30 px-6 py-4">
                                <div class="flex items-center justify-between">
                                    <div class="text-green-200/70 text-sm" id="visitor-pagination-info"></div>
                                    <div class="flex items-center gap-2" id="visitor-pagination-controls"></div>
                                </div>
                            </div>
                        </div>
                    </div>`;
                } else {
                    detailsHtml += `
                            <div class="text-center py-12">
                                <div class="w-16 h-16 bg-green-500/20 rounded-xl flex items-center justify-center mx-auto mb-4">
                                    <i class="ph ph-users text-2xl text-green-400"></i>
                                </div>
                                <p class="text-green-200/70">Tidak ada pemasukan dari visitor pada periode ini</p>
                            </div>
                        </div>`;
                }

                DOMElements.reports.detailsContent.innerHTML = detailsHtml;

                if (memberDetails.length > 0) initializeMemberPagination(memberDetails);
                if (visitorDetails.length > 0) initializeVisitorPagination(visitorDetails);
            }

            let currentMemberPage = 1;
            const memberItemsPerPage = 15;

            function initializeMemberPagination(memberDetails) {
                currentMemberPage = 1;
                renderMemberTablePage(memberDetails, currentMemberPage);
                renderMemberPaginationControls(memberDetails.length);
            }

            function renderMemberTablePage(memberDetails, page) {
                const startIndex = (page - 1) * memberItemsPerPage;
                const pageData = memberDetails.slice(startIndex, startIndex + memberItemsPerPage);
                const tableBody = document.getElementById('member-table-body');
                if (!tableBody) return;

                tableBody.innerHTML = pageData.map((item, index) => `
                    <tr class="border-b border-blue-500/10 hover:bg-blue-900/20 transition-all duration-200">
                        <td class="py-4 px-6 text-blue-100 font-medium">${startIndex + index + 1}</td>
                        <td class="py-4 px-6 text-blue-100">${formatDateShort(item.tanggalMulai.toDate())}</td>
                        <td class="py-4 px-6 text-blue-100 font-medium">${item.nama}</td>
                        <td class="py-4 px-6 text-blue-300 font-mono text-sm">${item.kodePendaftaran}</td>
                        <td class="py-4 px-6 text-blue-100"><span class="bg-blue-500/20 px-3 py-1 rounded-lg text-blue-300 text-sm font-medium">${item.paket}</span></td>
                        <td class="py-4 px-6 text-right"><span class="text-blue-300 font-bold text-lg">${formatRupiah(item.totalBayar)}</span></td>
                    </tr>
                `).join('');
            }

            function renderMemberPaginationControls(totalItems) {
                const totalPages = Math.ceil(totalItems / memberItemsPerPage);
                if (totalPages <= 1) {
                    document.getElementById('member-pagination-info').parentElement.parentElement.classList.add('hidden');
                    return;
                }
                document.getElementById('member-pagination-info').parentElement.parentElement.classList.remove('hidden');

                const startItem = totalItems === 0 ? 0 : ((currentMemberPage - 1) * memberItemsPerPage + 1);
                const endItem = Math.min(currentMemberPage * memberItemsPerPage, totalItems);

                document.getElementById('member-pagination-info').textContent = `Menampilkan ${startItem}-${endItem} dari ${totalItems} data`;
                
                const controlsEl = document.getElementById('member-pagination-controls');
                if (!controlsEl) return;
                controlsEl.innerHTML = '';

                const prevBtn = document.createElement('button');
                prevBtn.className = `px-3 py-2 text-sm rounded-lg border transition-all duration-200 ${currentMemberPage === 1 ? 'bg-gray-800 border-gray-600 text-gray-500 cursor-not-allowed' : 'bg-blue-600/20 border-blue-500/50 text-blue-300 hover:bg-blue-600/30 hover:border-blue-400'}`;
                prevBtn.innerHTML = '<i class="ph ph-caret-left"></i>';
                prevBtn.disabled = currentMemberPage === 1;
                prevBtn.onclick = () => {
                    if (currentMemberPage > 1) {
                        currentMemberPage--;
                        renderMemberTablePage(currentReportData.memberDetails, currentMemberPage);
                        renderMemberPaginationControls(totalItems);
                    }
                };
                controlsEl.appendChild(prevBtn);

                const nextBtn = document.createElement('button');
                nextBtn.className = `px-3 py-2 text-sm rounded-lg border transition-all duration-200 ${currentMemberPage === totalPages ? 'bg-gray-800 border-gray-600 text-gray-500 cursor-not-allowed' : 'bg-blue-600/20 border-blue-500/50 text-blue-300 hover:bg-blue-600/30 hover:border-blue-400'}`;
                nextBtn.innerHTML = '<i class="ph ph-caret-right"></i>';
                nextBtn.disabled = currentMemberPage === totalPages;
                nextBtn.onclick = () => {
                    if (currentMemberPage < totalPages) {
                        currentMemberPage++;
                        renderMemberTablePage(currentReportData.memberDetails, currentMemberPage);
                        renderMemberPaginationControls(totalItems);
                    }
                };
                controlsEl.appendChild(nextBtn);
            }

            let currentVisitorPage = 1;
            const visitorItemsPerPage = 15;

            function initializeVisitorPagination(visitorDetails) {
                currentVisitorPage = 1;
                renderVisitorTablePage(visitorDetails, currentVisitorPage);
                renderVisitorPaginationControls(visitorDetails.length);
            }

            function renderVisitorTablePage(visitorDetails, page) {
                const startIndex = (page - 1) * visitorItemsPerPage;
                const pageData = visitorDetails.slice(startIndex, startIndex + visitorItemsPerPage);
                const tableBody = document.getElementById('visitor-table-body');
                if (!tableBody) return;
                
                tableBody.innerHTML = pageData.map((item, index) => `
                    <tr class="border-b border-green-500/10 hover:bg-green-900/20 transition-all duration-200">
                        <td class="py-4 px-6 text-green-100 font-medium">${startIndex + index + 1}</td>
                        <td class="py-4 px-6 text-green-100">${item.tanggal}</td>
                        <td class="py-4 px-6 text-green-100 font-medium">${item.nama}</td>
                        <td class="py-4 px-6 text-right"><span class="text-green-300 font-bold text-lg">${formatRupiah(item.harga)}</span></td>
                    </tr>
                `).join('');
            }

            function renderVisitorPaginationControls(totalItems) {
                const totalPages = Math.ceil(totalItems / visitorItemsPerPage);
                 if (totalPages <= 1) {
                    document.getElementById('visitor-pagination-info').parentElement.parentElement.classList.add('hidden');
                    return;
                }
                document.getElementById('visitor-pagination-info').parentElement.parentElement.classList.remove('hidden');

                const startItem = totalItems === 0 ? 0 : ((currentVisitorPage - 1) * visitorItemsPerPage + 1);
                const endItem = Math.min(currentVisitorPage * visitorItemsPerPage, totalItems);

                document.getElementById('visitor-pagination-info').textContent = `Menampilkan ${startItem}-${endItem} dari ${totalItems} data`;
                
                const controlsEl = document.getElementById('visitor-pagination-controls');
                if (!controlsEl) return;
                controlsEl.innerHTML = '';
                
                const prevBtn = document.createElement('button');
                prevBtn.className = `px-3 py-2 text-sm rounded-lg border transition-all duration-200 ${currentVisitorPage === 1 ? 'bg-gray-800 border-gray-600 text-gray-500 cursor-not-allowed' : 'bg-green-600/20 border-green-500/50 text-green-300 hover:bg-green-600/30 hover:border-green-400'}`;
                prevBtn.innerHTML = '<i class="ph ph-caret-left"></i>';
                prevBtn.disabled = currentVisitorPage === 1;
                prevBtn.onclick = () => {
                    if (currentVisitorPage > 1) {
                        currentVisitorPage--;
                        renderVisitorTablePage(currentReportData.visitorDetails, currentVisitorPage);
                        renderVisitorPaginationControls(totalItems);
                    }
                };
                controlsEl.appendChild(prevBtn);

                const nextBtn = document.createElement('button');
                nextBtn.className = `px-3 py-2 text-sm rounded-lg border transition-all duration-200 ${currentVisitorPage === totalPages ? 'bg-gray-800 border-gray-600 text-gray-500 cursor-not-allowed' : 'bg-green-600/20 border-green-500/50 text-green-300 hover:bg-green-600/30 hover:border-green-400'}`;
                nextBtn.innerHTML = '<i class="ph ph-caret-right"></i>';
                nextBtn.disabled = currentVisitorPage === totalPages;
                nextBtn.onclick = () => {
                    if (currentVisitorPage < totalPages) {
                        currentVisitorPage++;
                        renderVisitorTablePage(currentReportData.visitorDetails, currentVisitorPage);
                        renderVisitorPaginationControls(totalItems);
                    }
                };
                controlsEl.appendChild(nextBtn);
            }

            // Fungsi generate laporan yang telah diperbarui
            async function generateReport(startDate, endDate, periodTitle) {
                DOMElements.reports.periodTitle.textContent = periodTitle;
                setReportLoading(true);

                try {
                    let memberDetails = [];
                    const memberQuery = query(collection(db, "pendaftaran_member"), where("tanggalMulai", ">=", startDate), where("tanggalMulai", "<=", endDate));
                    const memberSnapshot = await getDocs(memberQuery);
                    memberSnapshot.docs.filter(doc => doc.data().statusPembayaran === true).forEach(doc => memberDetails.push(doc.data()));
                    memberDetails.sort((a,b) => (a.tanggalMulai.seconds) - (b.tanggalMulai.seconds));

                    let visitorDetails = [];
                    const startDateId = formatDateForDocId(startDate);
                    const endDateId = formatDateForDocId(endDate);
                    const visitorQuery = query(collection(db, "daily_attendance"), where(documentId(), ">=", startDateId), where(documentId(), "<=", endDateId));
                    const visitorSnapshot = await getDocs(visitorQuery);
                    
                    const PRICE_CHANGE_DATE = new Date('2025-09-15T00:00:00');
                    const VISITOR_PRICE_OLD = 25000;
                    const VISITOR_PRICE_NEW = 35000;

                    visitorSnapshot.forEach(doc => {
                        const visitDateStr = doc.id;
                        const visitDate = new Date(visitDateStr);
                        visitDate.setMinutes(visitDate.getMinutes() + visitDate.getTimezoneOffset());
                        const price = visitDate >= PRICE_CHANGE_DATE ? VISITOR_PRICE_NEW : VISITOR_PRICE_OLD;
                        const entries = doc.data().entries || [];
                        entries.filter(e => e.type === 'Pengunjung').forEach(visitor => visitorDetails.push({ tanggal: visitDateStr, nama: visitor.nama, harga: price }));
                    });
                    visitorDetails.sort((a,b) => new Date(a.tanggal) - new Date(b.tanggal));

                    const currentPeriodIncome = await fetchIncomeForPeriod(startDate, endDate);
                    
                    const duration = endDate.getTime() - startDate.getTime();
                    const prevEndDate = new Date(startDate.getTime() - 1);
                    const prevStartDate = new Date(prevEndDate.getTime() - duration);
                    const previousPeriodIncome = await fetchIncomeForPeriod(prevStartDate, prevEndDate);
                    
                    const currentTotal = currentPeriodIncome.totalIncome;
                    const previousTotal = previousPeriodIncome.totalIncome;
                    let growthRate = 0;
                    if (previousTotal > 0) {
                        growthRate = ((currentTotal - previousTotal) / previousTotal) * 100;
                    } else if (currentTotal > 0) {
                        growthRate = 100;
                    }

                    renderReportUI({
                        totalIncome: currentPeriodIncome.totalIncome,
                        memberIncome: currentPeriodIncome.memberIncome,
                        visitorIncome: currentPeriodIncome.visitorIncome,
                        growthRate: growthRate,
                        memberDetails,
                        visitorDetails,
                        period: periodTitle,
                    });

                } catch (error) {
                    console.error("Error generating report:", error);
                    DOMElements.reports.detailsContent.innerHTML = `<p class="text-red-500 text-center py-8">Gagal memuat laporan. Silakan coba lagi.</p>`;
                }
            }

            function exportReport() {
                if (!currentReportData) {
                    alert("Silakan generate laporan terlebih dahulu sebelum mengunduh.");
                    return;
                }
                
                const { memberDetails, visitorDetails, period } = currentReportData;

                const memberSheet = memberDetails.map(item => ({
                    'Tanggal': formatDate(item.tanggalMulai),
                    'Nama': item.nama,
                    'No. Member': item.kodePendaftaran,
                    'Paket': item.paket,
                    'Jumlah': item.totalBayar,
                }));
                
                const visitorSheet = visitorDetails.map(item => ({
                    'Tanggal': item.tanggal,
                    'Nama Pengunjung': item.nama,
                    'Jumlah': item.harga,
                }));

                const filename = `laporan-pendapatan-${period.replace(/[^a-z0-9]/gi, '-').toLowerCase()}.xlsx`;
                
                exportToExcel(filename, [
                    { sheetName: 'Pendapatan Member', data: memberSheet },
                    { sheetName: 'Pendapatan Visitor', data: visitorSheet }
                ]);
            }

            function loadAllData() {
                loadMemberData();
                loadAttendanceHistory();
            }

            function switchView(viewToShow) {
                const views = [DOMElements.navigation.attendanceView, DOMElements.navigation.membersView, DOMElements.navigation.reportsView];
                const buttons = [DOMElements.navigation.showAttendanceBtn, DOMElements.navigation.showMembersBtn, DOMElements.navigation.showReportsBtn];
                
                views.forEach(v => v.classList.add('hidden'));
                buttons.forEach(b => b.classList.remove('active'));

                if (viewToShow === 'attendance') {
                    DOMElements.navigation.attendanceView.classList.remove('hidden');
                    DOMElements.navigation.showAttendanceBtn.classList.add('active');
                } else if (viewToShow === 'members') {
                    DOMElements.navigation.membersView.classList.remove('hidden');
                    DOMElements.navigation.showMembersBtn.classList.add('active');
                } else if (viewToShow === 'reports') {
                    DOMElements.navigation.reportsView.classList.remove('hidden');
                    DOMElements.navigation.showReportsBtn.classList.add('active');
                    if(!currentReportData){ 
                        const dailyBtn = document.querySelector('.report-period-btn[data-period="daily"]');
                        if (dailyBtn) dailyBtn.click();
                    }
                }
            }
            
            function switchMemberTab(tabToShow) {
                // Hide all tabs
                DOMElements.memberTabs.activeContent.classList.add('hidden');
                DOMElements.memberTabs.archiveContent.classList.add('hidden');
                
                // Remove active class from all buttons
                DOMElements.memberTabs.activeTab.classList.remove('active');
                DOMElements.memberTabs.archiveTab.classList.remove('active');
                
                if (tabToShow === 'active') {
                    DOMElements.memberTabs.activeContent.classList.remove('hidden');
                    DOMElements.memberTabs.activeTab.classList.add('active');
                } else if (tabToShow === 'archive') {
                    DOMElements.memberTabs.archiveContent.classList.remove('hidden');
                    DOMElements.memberTabs.archiveTab.classList.add('active');
                    loadArchiveData();
                }
            }

            // --- EVENT LISTENERS & LOGIKA UTAMA ---
            DOMElements.loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (DOMElements.passwordInput.value === ADMIN_PASSWORD) {
                    DOMElements.loginSection.classList.add('hidden');
                    DOMElements.adminDashboard.classList.remove('hidden');
                    loadAllData();
                    populateDateFilters();
                    switchView('attendance');
                } else {
                    DOMElements.loginError.classList.remove('hidden');
                }
            });

            DOMElements.togglePassword.addEventListener('click', () => {
                const type = DOMElements.passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                DOMElements.passwordInput.setAttribute('type', type);
                DOMElements.eyeIcon.classList.toggle('ph-eye');
                DOMElements.eyeIcon.classList.toggle('ph-eye-slash');
            });
            
            DOMElements.navigation.showAttendanceBtn.addEventListener('click', () => switchView('attendance'));
            DOMElements.navigation.showMembersBtn.addEventListener('click', () => switchView('members'));
            DOMElements.navigation.showReportsBtn.addEventListener('click', () => switchView('reports'));
            
            // Member tab switching
            DOMElements.memberTabs.activeTab.addEventListener('click', () => switchMemberTab('active'));
            DOMElements.memberTabs.archiveTab.addEventListener('click', () => switchMemberTab('archive'));

            // Fungsi filter dan search member
            function applyMemberFilters() {
                const searchTerm = DOMElements.members.searchInput.value.toLowerCase();
                const filterPaket = document.getElementById('filter-paket').value;
                const filterStatus = document.getElementById('filter-status').value;
                
                currentPage = 1;
                
                let filteredMembers = allMemberData.filter(member => {
                    // Filter search
                    const matchSearch = !searchTerm || 
                        member.nama.toLowerCase().includes(searchTerm) || 
                        member.kodePendaftaran.toLowerCase().includes(searchTerm);
                    
                    // Filter paket
                    const matchPaket = !filterPaket || member.paket.includes(filterPaket);
                    
                    // Filter status
                    let matchStatus = true;
                    if (filterStatus) {
                        const now = new Date();
                        const tanggalSelesai = member.tanggalSelesai?.toDate();
                        
                        if (filterStatus === 'lunas') {
                            matchStatus = member.statusPembayaran === true;
                        } else if (filterStatus === 'belum') {
                            matchStatus = member.statusPembayaran === false;
                        } else if (filterStatus === 'expired') {
                            matchStatus = tanggalSelesai && tanggalSelesai < now;
                        } else if (filterStatus === 'aktif') {
                            matchStatus = tanggalSelesai && tanggalSelesai >= now && member.statusPembayaran === true;
                        }
                    }
                    
                    return matchSearch && matchPaket && matchStatus;
                });
                
                // Sort hasil filter berdasarkan nomor member
                filteredMembers = sortMembersByCode(filteredMembers);
                
                renderMemberTable(filteredMembers);
            }
            
            DOMElements.members.searchInput.addEventListener('input', applyMemberFilters);
            document.getElementById('filter-paket').addEventListener('change', applyMemberFilters);
            document.getElementById('filter-status').addEventListener('change', applyMemberFilters);

            DOMElements.members.exportBtn.addEventListener('click', () => {
                const dataForExport = allMemberData.map(m => ({ 
                    'No. Member': m.kodePendaftaran, 'Nama Lengkap': m.nama, 'Tanggal Lahir': formatDate(m.tanggalLahir),
                    'Alamat Lengkap': m.alamat, 'No. WhatsApp': m.whatsapp, 'Email': m.email, 'Paket': m.paket, 
                    'Tanggal Mulai': formatDate(m.tanggalMulai), 'Tanggal Selesai': formatDate(m.tanggalSelesai),
                    'Total Bayar': m.totalBayar, 'Status Bayar': m.statusPembayaran ? 'Lunas' : 'Belum Lunas'
                }));
                exportToExcel('pendaftar_member.xlsx', [{ sheetName: 'Pendaftar Member', data: dataForExport }]);
            });

            DOMElements.attendance.startScanBtn.addEventListener('click', () => {
                DOMElements.attendance.scannerModal.classList.remove('hidden');
                html5QrCode = new Html5Qrcode("reader");
                const onScanSuccess = (decodedText, decodedResult) => {
                    handleMemberAttendance(decodedText);
                    if (html5QrCode && html5QrCode.isScanning) {
                        html5QrCode.stop().catch(err => console.error("Gagal menghentikan scanner:", err));
                    }
                    DOMElements.attendance.scannerModal.classList.add('hidden');
                };
                const onScanFailure = (error) => { /* ignore */ };
                
                Html5Qrcode.getCameras().then(devices => {
                    if (devices && devices.length) {
                        const cameraId = devices.find(d => d.label.toLowerCase().includes('back'))?.id || devices[0].id;
                        html5QrCode.start(cameraId, { fps: 10, qrbox: { width: 250, height: 250 } }, onScanSuccess, onScanFailure)
                            .catch(err => {
                                console.error("Gagal memulai scanner:", err);
                                showAttendanceResult('error', { message: 'Tidak dapat memulai kamera. Pastikan Anda telah memberikan izin akses kamera.' });
                            });
                    } else {
                         console.error("Tidak ada kamera ditemukan.");
                         showAttendanceResult('error', { message: 'Tidak ada kamera yang ditemukan di perangkat ini.' });
                    }
                }).catch(err => {
                    console.error("Error mendapatkan akses kamera:", err);
                    showAttendanceResult('error', { message: 'Gagal mendapatkan akses kamera. Mohon berikan izin pada browser.' });
                });
            });

            DOMElements.attendance.stopScanBtn.addEventListener('click', () => {
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop().catch(err => console.error("Gagal menghentikan scanner:", err));
                }
                DOMElements.attendance.scannerModal.classList.add('hidden');
            });

            DOMElements.attendance.manualForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const noMember = DOMElements.attendance.manualInput.value;
                if (noMember) handleMemberAttendance(noMember.toUpperCase());
                DOMElements.attendance.manualInput.value = '';
            });

            DOMElements.attendance.exportBtn.addEventListener('click', exportAttendanceHistory);
            
            DOMElements.attendance.visitorForm.addEventListener('submit', handleVisitorSubmit);

            DOMElements.members.archiveBtn.addEventListener('click', () => {
                DOMElements.members.archiveConfirmModal.classList.remove('hidden');
            });
            DOMElements.members.cancelArchiveBtn.addEventListener('click', () => {
                DOMElements.members.archiveConfirmModal.classList.add('hidden');
            });
            DOMElements.members.confirmArchiveBtn.addEventListener('click', archiveInactiveMembers);
            
            // Archive event listeners
            DOMElements.archive.searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                if (!searchTerm) {
                    renderArchiveTable(allArchiveData);
                    return;
                }
                const filteredArchive = allArchiveData.filter(member => 
                    member.nama.toLowerCase().includes(searchTerm) || 
                    member.kodePendaftaran.toLowerCase().includes(searchTerm)
                );
                renderArchiveTable(filteredArchive);
            });
            
            DOMElements.archive.cancelRestoreBtn.addEventListener('click', () => {
                DOMElements.archive.restoreModal.classList.add('hidden');
                memberToRestore = null;
            });
            
            DOMElements.archive.confirmRestoreBtn.addEventListener('click', restoreMember);
            
            // Delete member event listeners
            DOMElements.deleteMember.cancelBtn.addEventListener('click', () => {
                DOMElements.deleteMember.modal.classList.add('hidden');
                memberToDelete = null;
            });
            
            DOMElements.deleteMember.confirmBtn.addEventListener('click', deleteMember);
            
            DOMElements.reports.filterButtons.addEventListener('click', (e) => {
                if (e.target.classList.contains('report-period-btn')) {
                    const period = e.target.dataset.period;
                    
                    document.querySelectorAll('.report-period-btn').forEach(btn => {
                        btn.classList.add('btn-secondary');
                        btn.classList.remove('btn-primary');
                    });
                    e.target.classList.add('btn-primary');
                    e.target.classList.remove('btn-secondary');

                    const now = new Date();
                    let startDate, endDate = new Date(now);
                    endDate.setHours(23, 59, 59, 999);
                    let periodTitle = '';

                    switch (period) {
                        case 'daily':
                            startDate = new Date(now);
                            startDate.setHours(0, 0, 0, 0);
                            periodTitle = `Laporan Harian - ${formatDateShort(now)}`;
                            break;
                        case 'weekly':
                            startDate = new Date(now);
                            const dayOfWeek = now.getDay();
                            const diff = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                            startDate.setDate(diff);
                            startDate.setHours(0, 0, 0, 0);
                            periodTitle = `Laporan Mingguan (${formatDateShort(startDate)} - ${formatDateShort(endDate)})`;
                            break;
                        case 'monthly':
                            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                            startDate.setHours(0, 0, 0, 0);
                            periodTitle = `Laporan Bulanan - ${now.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' })}`;
                            break;
                    }
                    
                    DOMElements.reports.startDateInput.value = '';
                    DOMElements.reports.endDateInput.value = '';
                    generateReport(startDate, endDate, periodTitle);
                }
            });

            const handleMonthYearChange = () => {
                const year = parseInt(DOMElements.reports.yearSelect.value);
                const month = parseInt(DOMElements.reports.monthSelect.value);
                const startDate = new Date(year, month, 1);
                const endDate = new Date(year, month + 1, 0, 23, 59, 59, 999);
                const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
                const periodTitle = `Laporan Bulan ${months[month]} ${year}`;
                
                DOMElements.reports.startDateInput.value = '';
                DOMElements.reports.endDateInput.value = '';
                document.querySelectorAll('.report-period-btn').forEach(btn => {
                    btn.classList.add('btn-secondary');
                    btn.classList.remove('btn-primary');
                });
                generateReport(startDate, endDate, periodTitle);
            };

            DOMElements.reports.monthSelect.addEventListener('change', handleMonthYearChange);
            DOMElements.reports.yearSelect.addEventListener('change', handleMonthYearChange);

            DOMElements.reports.applyCustomDateBtn.addEventListener('click', () => {
                const startDateValue = DOMElements.reports.startDateInput.value;
                const endDateValue = DOMElements.reports.endDateInput.value;

                if (!startDateValue || !endDateValue) {
                    alert("Silakan pilih tanggal mulai dan tanggal selesai.");
                    return;
                }

                const startDate = new Date(startDateValue);
                startDate.setHours(0, 0, 0, 0);
                const endDate = new Date(endDateValue);
                endDate.setHours(23, 59, 59, 999);

                if (startDate > endDate) {
                    alert("Tanggal mulai tidak boleh lebih besar dari tanggal selesai.");
                    return;
                }

                const periodTitle = `Laporan Kustom (${formatDateShort(startDate)} - ${formatDateShort(endDate)})`;
                document.querySelectorAll('.report-period-btn').forEach(btn => {
                     btn.classList.add('btn-secondary');
                    btn.classList.remove('btn-primary');
                });
                generateReport(startDate, endDate, periodTitle);
            });

            DOMElements.reports.exportBtn.addEventListener('click', exportReport);
        });
    </script>
</body>
</html>
