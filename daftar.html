<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pendaftaran Member - Vinca Gym</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #121212; color: #e0e0e0; }
        .card { background: #242424; border-radius: 1rem; border: 1px solid #333333; }
        .btn-primary { background-color: #ffffff; color: #121212; font-weight: 600; transition: all 0.3s ease; }
        .btn-primary:hover { background-color: #dcdcdc; }
        .btn-success { background-color: #10b981; color: white; font-weight: 600; transition: all 0.3s ease; }
        .btn-success:hover { background-color: #059669; }
        .btn-secondary { background-color: #6b7280; color: white; font-weight: 600; transition: all 0.3s ease; }
        .btn-secondary:hover { background-color: #4b5563; }
        input, textarea, input[type="date"] { background-color: #333; border: 1px solid #555; color: white; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); }
        .copy-btn { background-color: transparent; border: none; cursor: pointer; }
        .tooltip { visibility: hidden; opacity: 0; transition: opacity 0.3s; }
        .copy-btn:hover .tooltip { visibility: visible; opacity: 1; }
        .voucher-section { border: 1px dashed #6b7280; border-radius: 0.75rem; background: #1f2937; padding: 1rem; margin: 1rem 0; }
        .voucher-success { border-color: #10b981; background: rgba(16, 185, 129, 0.1); }
        .voucher-error { border-color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        .voucher-hidden { display: none; }
        .voucher-link { color: #93c5fd; text-decoration: underline; cursor: pointer; font-size: 0.875rem; }
        .voucher-link:hover { color: #bfdbfe; }
        .discount-highlight { color: #10b981; font-weight: 600; }
        .original-price { text-decoration: line-through; color: #9ca3af; }
    </style>
</head>
<body class="antialiased">
    <!-- Header -->
    <header class="bg-black/80 backdrop-blur-lg sticky top-0 z-50 shadow-lg shadow-black/20">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="flex items-center gap-3 text-2xl font-bold text-white">
                <img src="https://i.imgur.com/upiRXbW.png" alt="Vinca Gym Logo" class="h-10 w-auto">
                <span>Vinca Gym</span>
            </a>
        </nav>
    </header>
    <!-- Main Content -->
    <main class="min-h-screen flex items-center justify-center py-12 px-4">
        <div id="form-container" class="card p-8 w-full max-w-lg">
            <h1 class="text-3xl font-bold text-center text-white mb-4">Formulir Pendaftaran Member</h1>

            <!-- Voucher Section -->
            <div class="voucher-section voucher-hidden" id="voucher-section">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-white font-semibold">Kode Voucher</h3>
                    <button id="close-voucher-btn" class="text-gray-400 hover:text-white">
                        <i class="ph ph-x text-lg"></i>
                    </button>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="voucher-code" class="flex-1 px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-white uppercase" placeholder="Masukkan kode voucher">
                    <button id="apply-voucher-btn" class="btn-secondary px-4 py-2 rounded-md flex items-center">
                        <span id="voucher-btn-text">Terapkan</span>
                        <div id="voucher-spinner" class="w-4 h-4 border-2 border-white border-dashed rounded-full animate-spin hidden ml-2"></div>
                    </button>
                </div>
                <div id="voucher-message" class="mt-2 text-sm hidden"></div>
                <div id="voucher-details" class="mt-3 p-3 bg-green-900/20 rounded-lg border border-green-500/30 hidden">
                    <div class="flex items-center gap-2 text-green-400">
                        <i class="ph ph-check-circle"></i>
                        <span class="font-semibold">Voucher Berhasil Diterapkan!</span>
                    </div>
                    <div class="mt-2 text-sm text-green-300">
                        <div id="voucher-info"></div>
                    </div>
                </div>
            </div>

            <!-- Rincian Biaya -->
            <div class="bg-gray-800/50 p-6 rounded-lg border border-gray-700 mb-6">
                <h2 class="text-xl font-semibold text-white mb-4">Rincian Biaya</h2>
                <div class="space-y-2 text-gray-300">
                    <div class="flex justify-between"><span>Paket Pilihan:</span><strong id="paket-nama" class="text-white">Memuat...</strong></div>
                    <div class="flex justify-between"><span>Harga Paket:</span><span id="paket-harga">Rp 0</span></div>
                    <div id="biaya-member-container" class="flex justify-between"><span>Biaya Member Baru:</span><span id="biaya-member-harga">Rp 50.000</span></div>
                    <div id="voucher-discount-container" class="flex justify-between hidden">
                        <span>Diskon Voucher:</span>
                        <span id="voucher-discount-amount" class="discount-highlight">-Rp 0</span>
                    </div>
                    <hr class="border-gray-600 my-2">
                    <div class="flex justify-between text-lg font-bold">
                        <span class="text-white">Total Bayar:</span>
                        <div class="flex items-center gap-2">
                            <span id="total-original" class="original-price text-sm hidden">Rp 0</span>
                            <span id="total-bayar" class="text-white">Rp 50.000</span>
                        </div>
                    </div>
                </div>
                <div class="mt-4">
                    <span class="voucher-link" id="show-voucher-link">Ada kode voucher? Klik di sini</span>
                </div>
            </div>

            <!-- Form -->
            <form id="pendaftaran-form">
                <div class="mb-4"><label for="nama-lengkap" class="block text-sm font-medium text-gray-300 mb-1">Nama Lengkap</label><input type="text" id="nama-lengkap" class="w-full px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-white" required></div>
                <div class="mb-4"><label for="tanggal-lahir" class="block text-sm font-medium text-gray-300 mb-1">Tanggal Lahir</label><input type="date" id="tanggal-lahir" class="w-full px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-white" required></div>
                <div class="mb-4">
                    <label for="whatsapp" class="block text-sm font-medium text-gray-300 mb-1">No. WhatsApp</label>
                    <div class="flex">
                        <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-500 bg-gray-300 text-black text-sm font-semibold">+62</span>
                        <input type="tel" id="whatsapp" class="w-full px-3 py-2 rounded-r-md bg-gray-300 text-black placeholder-gray-600 focus:outline-none focus:ring-2 focus:ring-white" required placeholder="8123456789">
                    </div>
                </div>
                <div class="mb-4"><label for="email" class="block text-sm font-medium text-gray-300 mb-1">Email (Opsional)</label><input type="email" id="email" class="w-full px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-white"></div>
                <div class="mb-6"><label for="alamat" class="block text-sm font-medium text-gray-300 mb-1">Alamat Lengkap</label><textarea id="alamat" rows="3" class="w-full px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-white" required></textarea></div>
                <button type="submit" id="submit-pendaftaran" class="w-full btn-primary py-3 rounded-md flex items-center justify-center"><span id="submit-text">Daftar Sekarang</span><div id="submit-spinner" class="w-5 h-5 border-2 border-black border-dashed rounded-full animate-spin hidden ml-2"></div></button>
            </form>
        </div>
        <!-- Success Message -->
        <div id="success-message" class="hidden text-center max-w-lg w-full">
            <div class="mx-auto bg-green-900/50 w-24 h-24 rounded-full flex items-center justify-center border-2 border-green-500"><i class="ph ph-check-fat text-6xl text-green-400"></i></div>
            <h1 class="text-3xl font-bold mt-6 text-white">Pendaftaran Berhasil!</h1>
            <p class="text-gray-300 mt-2">Terima kasih telah mendaftar. Silakan lakukan pembayaran untuk mengaktifkan membership Anda.</p>

            <div id="payment-info" class="card p-6 mt-6 text-left">
                <div class="flex items-center justify-between">
                    <p class="text-lg">No. Member: <strong id="kode-sukses" class="text-yellow-400 font-mono"></strong></p>
                    <button id="copy-kode-btn" class="copy-btn relative text-gray-400 hover:text-white"><i class="ph ph-copy"></i><span class="tooltip absolute -top-8 left-1/2 -translate-x-1/2 bg-black text-white text-xs px-2 py-1 rounded">Salin</span></button>
                </div>

                <!-- Rincian Pembayaran di Success Message -->
                <div class="bg-gray-800/50 p-4 rounded-lg border border-gray-700 my-4">
                    <h3 class="font-bold text-white mb-3">Rincian Pembayaran</h3>
                    <div class="space-y-2 text-sm text-gray-300">
                        <div class="flex justify-between">
                            <span>Paket:</span>
                            <span id="success-paket-nama" class="text-white font-medium"></span>
                        </div>
                        <div class="flex justify-between">
                            <span>Harga Paket:</span>
                            <span id="success-paket-harga"></span>
                        </div>
                        <div class="flex justify-between">
                            <span>Biaya Member Baru:</span>
                            <span id="success-biaya-member">Rp 50.000</span>
                        </div>
                        <div id="success-voucher-container" class="flex justify-between hidden">
                            <span>Diskon Voucher:</span>
                            <span id="success-voucher-discount" class="text-green-400"></span>
                        </div>
                        <hr class="border-gray-600 my-2">
                        <div class="flex justify-between text-base font-semibold">
                            <span>Total Pembayaran:</span>
                            <span id="success-total-bayar" class="text-yellow-400"></span>
                        </div>
                    </div>
                </div>

                <hr class="border-gray-600 my-4">
                <h3 class="font-bold text-white mb-2">Metode Pembayaran:</h3>
                <div class="flex flex-col md:flex-row gap-4 items-center">
                    <!-- QRIS -->
                    <div class="w-full md:w-1/2 flex flex-col items-center">
                        <img src="qris-logo.png" alt="QRIS Logo" class="h-6 mb-3">
                        <img src="qris-code.png" alt="QRIS Code" class="rounded-lg w-40 h-40 border-4 border-white">
                    </div>
                     <!-- Bank Transfer -->
                    <div class="w-full md:w-1/2 flex flex-col items-center md:items-start">
                        <img src="bca-logo.png" alt="BCA Logo" class="h-6 mb-3">
                        <p class="font-semibold">Bank BCA</p>
                        <div class="flex items-center gap-2">
                           <p id="rekening-nomor" class="font-mono text-lg">4060622839</p>
                            <button id="copy-rekening-btn" class="copy-btn relative text-gray-400 hover:text-white"><i class="ph ph-copy"></i><span class="tooltip absolute -top-8 left-1/2 -translate-x-1/2 bg-black text-white text-xs px-2 py-1 rounded">Salin</span></button>
                        </div>
                        <p>a.n. RIMA RIZKY AMELIA</p>
                    </div>
                </div>
                <p class="text-xs text-gray-400 mt-4 text-center italic">
                    Harap konfirmasi dan mengirimkan foto bukti transfer melalui nomor Whatsapp kami dibawah ini. Barakallahu fiik.
                </p>
            </div>

            <div class="mt-6 flex flex-col sm:flex-row gap-4">
                <button id="download-payment-btn" class="w-full bg-gray-600 text-white py-3 rounded-md flex items-center justify-center gap-2 hover:bg-gray-700">
                    <i id="download-icon" class="ph ph-download-simple"></i>
                    <span id="download-text">Unduh Info Pembayaran</span>
                    <div id="download-spinner" class="w-5 h-5 border-2 border-white border-dashed rounded-full animate-spin hidden"></div>
                </button>
                <a id="whatsapp-confirm-btn" href="#" target="_blank" class="w-full bg-green-500 text-white py-3 rounded-md flex items-center justify-center gap-2 hover:bg-green-600"><i class="ph ph-whatsapp-logo"></i>Konfirmasi via WhatsApp</a>
            </div>
             <a href="index.html" class="mt-4 inline-block text-gray-400 hover:text-white py-3 px-8 rounded-md">Kembali ke Halaman Utama</a>
        </div>
    </main>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Tambahkan setDoc, getDoc ke import
        import { getFirestore, collection, setDoc, doc, runTransaction, query, where, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        const firebaseConfig = { apiKey: "AIzaSyBJsVSa2KVdB7w3A-5c9i5MqcpdaqZ_lqQ", authDomain: "vinca-gym-website.firebaseapp.com", projectId: "vinca-gym-website", storageBucket: "vinca-gym-website.firebasestorage.app", messagingSenderId: "430179505282", appId: "1:430179505282:web:e7128a258fb64cebcb109b", measurementId: "G-5KVHK8RPK9" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const PAKET_MEMBERSHIP = {
            regular: { nama: "Regular (1 Bulan)", harga: 200000, prefix: "R", durasiBulan: 1 },
            silver: { nama: "Silver (3 Bulan)", harga: 525000, prefix: "S", durasiBulan: 3 },
            gold: { nama: "Gold (6 Bulan)", harga: 900000, prefix: "G", durasiBulan: 6 },
            platinum: { nama: "Platinum (1 Tahun)", harga: 1200000, prefix: "P", durasiBulan: 12 }
        };
        const BIAYA_MEMBER_BARU = 50000;
        const GRAND_OPENING_DEADLINE = new Date('2025-08-18T00:00:00');

        const pendaftaranForm = document.getElementById('pendaftaran-form');
        const formContainer = document.getElementById('form-container');
        const successMessage = document.getElementById('success-message');
        const downloadPaymentBtn = document.getElementById('download-payment-btn');
        const copyKodeBtn = document.getElementById('copy-kode-btn');
        const copyRekeningBtn = document.getElementById('copy-rekening-btn');

        let paketTerpilih = null;
        let paketKeyGlobal = null;
        let isPromoActive = false;
        let appliedVoucher = null;
        let totalHargaAwal = 0;
        let totalHargaAkhir = 0;

        function formatRupiah(angka) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka); }

        // --- NEW SMART GENERATOR (ANTI-DUPLICATE) ---
        async function generateSmartUniqueCode(packageKey) {
            const counterRef = doc(db, "counters", "member_registration");
            let isUnique = false;
            let finalCode = "";
            let attempts = 0;
            
            // 1. Ambil estimasi counter terakhir (baca langsung agar cepat)
            // Kita akan meloop sampai menemukan slot yang benar-benar kosong
            let candidateCount = 1;
            try {
                const counterSnap = await getDoc(counterRef);
                if (counterSnap.exists() && counterSnap.data()[packageKey]) {
                    candidateCount = counterSnap.data()[packageKey] + 1;
                }
            } catch (e) {
                console.log("Counter belum ada, mulai dari 1");
            }

            // Loop Safety: Maksimal mencoba 50x loncat angka untuk mencegah infinite loop
            while (!isUnique && attempts < 50) { 
                const prefix = `VG-${PAKET_MEMBERSHIP[packageKey].prefix}`;
                const paddedNumber = String(candidateCount).padStart(4, '0');
                const candidateCode = `${prefix}${paddedNumber}`;
                
                // Cek 1: Apakah dokumen dengan ID ini sudah ada? (Untuk sistem baru)
                const docRef = doc(db, "pendaftaran_member", candidateCode);
                const docSnap = await getDoc(docRef);
                
                // Cek 2: Apakah ada dokumen (legacy/lama) yang punya field kodePendaftaran ini? (Untuk sistem lama)
                const q = query(collection(db, "pendaftaran_member"), where("kodePendaftaran", "==", candidateCode));
                const querySnap = await getDocs(q);
                
                if (!docSnap.exists() && querySnap.empty) {
                    // AMAN! Kode ini kosong di kedua sistem
                    finalCode = candidateCode;
                    isUnique = true;
                } else {
                    // TABRAKAN! Nomor ini sudah ada, coba nomor berikutnya
                    console.log(`Tabrakan ditemukan untuk ${candidateCode}, mencoba nomor berikutnya...`);
                    candidateCount++;
                }
                attempts++;
            }

            if (!isUnique) throw new Error("Gagal generate kode unik. Silakan hubungi admin.");

            // 2. Update Counter di Database ke angka tertinggi yang baru saja kita temukan
            // Menggunakan transaction agar aman jika ada banyak pendaftar bersamaan
            await runTransaction(db, async (transaction) => {
                const cDoc = await transaction.get(counterRef);
                let currentDbCount = 0;
                if (cDoc.exists() && cDoc.data()[packageKey]) {
                    currentDbCount = cDoc.data()[packageKey];
                }
                
                // Hanya update jika angka kita lebih tinggi (biar counter maju terus)
                if (candidateCount > currentDbCount) {
                     const updateData = {};
                     updateData[packageKey] = candidateCount;
                     transaction.set(counterRef, updateData, { merge: true });
                }
            });

            return finalCode;
        }

        // Voucher Management Functions
        async function validateVoucherCode(voucherCode) {
            try {
                const q = query(collection(db, "vouchers"), where("code", "==", voucherCode.toUpperCase()), where("isActive", "==", true));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    return { valid: false, message: "Kode voucher tidak valid atau sudah tidak aktif" };
                }

                const voucherDoc = querySnapshot.docs[0];
                const voucherData = voucherDoc.data();
                const now = new Date();

                // Check expiry date
                if (voucherData.expiryDate && voucherData.expiryDate.toDate() < now) {
                    return { valid: false, message: "Kode voucher sudah kedaluwarsa" };
                }

                // Check usage limit
                if (voucherData.maxUses && voucherData.currentUses >= voucherData.maxUses) {
                    return { valid: false, message: "Kode voucher sudah mencapai batas penggunaan" };
                }

                // Check minimum purchase amount
                if (voucherData.minPurchase && totalHargaAwal < voucherData.minPurchase) {
                    return { 
                        valid: false, 
                        message: `Minimum pembelian ${formatRupiah(voucherData.minPurchase)} untuk menggunakan voucher ini` 
                    };
                }

                return { 
                    valid: true, 
                    voucher: { id: voucherDoc.id, ...voucherData },
                    message: "Voucher berhasil diterapkan!"
                };

            } catch (error) {
                console.error("Error validating voucher:", error);
                return { valid: false, message: "Terjadi kesalahan saat memvalidasi voucher" };
            }
        }

        function calculateDiscount(voucher, totalAmount) {
            let discountAmount = 0;

            if (voucher.discountType === 'percentage') {
                discountAmount = (totalAmount * voucher.discountValue) / 100;
                // Apply max discount if specified
                if (voucher.maxDiscount && discountAmount > voucher.maxDiscount) {
                    discountAmount = voucher.maxDiscount;
                }
            } else if (voucher.discountType === 'fixed') {
                discountAmount = voucher.discountValue;
            }

            // Ensure discount doesn't exceed total amount
            discountAmount = Math.min(discountAmount, totalAmount);

            return discountAmount;
        }

        function updatePriceDisplay() {
            const voucherDiscountContainer = document.getElementById('voucher-discount-container');
            const voucherDiscountAmount = document.getElementById('voucher-discount-amount');
            const totalOriginal = document.getElementById('total-original');
            const totalBayar = document.getElementById('total-bayar');

            if (appliedVoucher) {
                const discountAmount = calculateDiscount(appliedVoucher, totalHargaAwal);
                totalHargaAkhir = totalHargaAwal - discountAmount;

                voucherDiscountAmount.textContent = `-${formatRupiah(discountAmount)}`;
                voucherDiscountContainer.classList.remove('hidden');

                totalOriginal.textContent = formatRupiah(totalHargaAwal);
                totalOriginal.classList.remove('hidden');
                totalBayar.textContent = formatRupiah(totalHargaAkhir);
                totalBayar.classList.add('discount-highlight');
            } else {
                voucherDiscountContainer.classList.add('hidden');
                totalOriginal.classList.add('hidden');
                totalBayar.textContent = formatRupiah(totalHargaAwal);
                totalBayar.classList.remove('discount-highlight');
                totalHargaAkhir = totalHargaAwal;
            }
        }

        function updateSuccessPaymentInfo() {
            // Update rincian pembayaran di success message
            document.getElementById('success-paket-nama').textContent = paketTerpilih.nama;
            document.getElementById('success-paket-harga').textContent = formatRupiah(paketTerpilih.harga);
            document.getElementById('success-biaya-member').textContent = formatRupiah(BIAYA_MEMBER_BARU);
            document.getElementById('success-total-bayar').textContent = formatRupiah(totalHargaAkhir);

            // Tampilkan diskon voucher di success message jika ada
            const successVoucherContainer = document.getElementById('success-voucher-container');
            if (appliedVoucher && (totalHargaAwal - totalHargaAkhir) > 0) {
                const diskonAmount = totalHargaAwal - totalHargaAkhir;
                document.getElementById('success-voucher-discount').textContent = `- ${formatRupiah(diskonAmount)}`;
                successVoucherContainer.classList.remove('hidden');
            } else {
                successVoucherContainer.classList.add('hidden');
            }
        }

        // Voucher UI Event Handlers
        document.getElementById('show-voucher-link').addEventListener('click', () => {
            document.getElementById('voucher-section').classList.remove('voucher-hidden');
            document.getElementById('voucher-code').focus();
        });

        document.getElementById('close-voucher-btn').addEventListener('click', () => {
            document.getElementById('voucher-section').classList.add('voucher-hidden');
            document.getElementById('voucher-code').value = '';
            document.getElementById('voucher-message').classList.add('hidden');
            document.getElementById('voucher-details').classList.add('hidden');
        });

        document.getElementById('apply-voucher-btn').addEventListener('click', async () => {
            const voucherCode = document.getElementById('voucher-code').value.trim();
            const applyBtn = document.getElementById('apply-voucher-btn');
            const btnText = document.getElementById('voucher-btn-text');
            const spinner = document.getElementById('voucher-spinner');
            const messageDiv = document.getElementById('voucher-message');
            const detailsDiv = document.getElementById('voucher-details');
            const voucherSection = document.getElementById('voucher-section');

            if (!voucherCode) {
                messageDiv.textContent = "Silakan masukkan kode voucher";
                messageDiv.className = "mt-2 text-sm text-red-400";
                messageDiv.classList.remove('hidden');
                return;
            }

            // Loading state
            applyBtn.disabled = true;
            btnText.classList.add('hidden');
            spinner.classList.remove('hidden');
            messageDiv.classList.add('hidden');
            detailsDiv.classList.add('hidden');

            const result = await validateVoucherCode(voucherCode);

            if (result.valid) {
                appliedVoucher = result.voucher;
                const discountAmount = calculateDiscount(appliedVoucher, totalHargaAwal);

                // Show success state
                voucherSection.classList.add('voucher-success');
                voucherSection.classList.remove('voucher-error');

                document.getElementById('voucher-info').innerHTML = `
                    <div>Kode: <strong>${appliedVoucher.code}</strong></div>
                    <div>Deskripsi: ${appliedVoucher.description || 'Diskon spesial'}</div>
                    <div>Diskon: ${formatRupiah(discountAmount)}</div>
                `;
                detailsDiv.classList.remove('hidden');

                updatePriceDisplay();

                // Change button to "Hapus"
                btnText.textContent = 'Hapus';
                document.getElementById('voucher-code').disabled = true;

            } else {
                // Show error state
                voucherSection.classList.add('voucher-error');
                voucherSection.classList.remove('voucher-success');

                messageDiv.textContent = result.message;
                messageDiv.className = "mt-2 text-sm text-red-400";
                messageDiv.classList.remove('hidden');
            }

            // Reset loading state
            applyBtn.disabled = false;
            btnText.classList.remove('hidden');
            spinner.classList.add('hidden');
        });

        // Remove voucher functionality
        document.getElementById('apply-voucher-btn').addEventListener('click', (e) => {
            if (appliedVoucher && document.getElementById('voucher-btn-text').textContent === 'Hapus') {
                e.preventDefault();
                e.stopPropagation();

                // Reset voucher state
                appliedVoucher = null;
                document.getElementById('voucher-code').value = '';
                document.getElementById('voucher-code').disabled = false;
                document.getElementById('voucher-btn-text').textContent = 'Terapkan';
                document.getElementById('voucher-details').classList.add('hidden');
                document.getElementById('voucher-section').classList.remove('voucher-success', 'voucher-error');

                updatePriceDisplay();
            }
        });

        function initializePage() {
            const params = new URLSearchParams(window.location.search);
            paketKeyGlobal = params.get('paket');
            paketTerpilih = PAKET_MEMBERSHIP[paketKeyGlobal] || null;

            if (paketTerpilih) {
                const now = new Date();
                isPromoActive = now < GRAND_OPENING_DEADLINE;
                const biayaMember = isPromoActive ? 0 : BIAYA_MEMBER_BARU;
                totalHargaAwal = paketTerpilih.harga + biayaMember;
                totalHargaAkhir = totalHargaAwal;

                document.getElementById('paket-nama').textContent = paketTerpilih.nama;
                document.getElementById('paket-harga').textContent = formatRupiah(paketTerpilih.harga);

                const biayaMemberContainer = document.getElementById('biaya-member-container');
                if(isPromoActive) {
                    biayaMemberContainer.innerHTML = `<span>Biaya Member Baru:</span><span class="text-green-400">GRATIS (Promo Grand Opening)</span>`;
                } else {
                    document.getElementById('biaya-member-harga').textContent = formatRupiah(biayaMember);
                }

                document.getElementById('total-bayar').textContent = formatRupiah(totalHargaAwal);
            } else {
                formContainer.innerHTML = `<h1 class="text-2xl font-bold text-center text-red-400">Paket tidak valid.</h1><p class="text-center mt-2">Silakan kembali ke halaman utama dan pilih paket yang tersedia.</p><a href="index.html" class="mt-6 inline-block btn-primary py-2 px-6 rounded-md">Kembali</a>`;
            }
        }

        document.addEventListener('DOMContentLoaded', initializePage);

        pendaftaranForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!paketTerpilih || !paketKeyGlobal) return;

            const submitButton = document.getElementById('submit-pendaftaran');
            const submitText = document.getElementById('submit-text');
            const submitSpinner = document.getElementById('submit-spinner');
            submitButton.disabled = true;
            submitText.classList.add('hidden');
            submitSpinner.classList.remove('hidden');

            try {
                // GENERATE CODE USING NEW SMART FUNCTION
                const newRegistrationCode = await generateSmartUniqueCode(paketKeyGlobal);
                
                const tanggalMulai = new Date();
                
                const tanggalSelesai = new Date(tanggalMulai);
                const targetMonth = tanggalSelesai.getMonth() + paketTerpilih.durasiBulan;
                const targetYear = tanggalSelesai.getFullYear() + Math.floor(targetMonth / 12);
                const finalMonth = targetMonth % 12;
                
                tanggalSelesai.setFullYear(targetYear);
                tanggalSelesai.setMonth(finalMonth);
                
                const dayOfMonth = tanggalMulai.getDate();
                const lastDayOfTargetMonth = new Date(targetYear, finalMonth + 1, 0).getDate();
                tanggalSelesai.setDate(Math.min(dayOfMonth, lastDayOfTargetMonth));

                const whatsappInput = document.getElementById('whatsapp').value.replace(/\D/g, '');
                const whatsappNumber = `62${whatsappInput.startsWith('0') ? whatsappInput.substring(1) : whatsappInput}`;

                const pendaftar = {
                    nama: document.getElementById('nama-lengkap').value,
                    tanggalLahir: new Date(document.getElementById('tanggal-lahir').value),
                    whatsapp: whatsappNumber,
                    email: document.getElementById('email').value,
                    alamat: document.getElementById('alamat').value,
                    paket: paketTerpilih.nama,
                    totalBayar: totalHargaAkhir,
                    totalHargaAwal: totalHargaAwal,
                    kodePendaftaran: newRegistrationCode,
                    tanggalMulai: tanggalMulai,
                    tanggalSelesai: tanggalSelesai,
                    statusPembayaran: false,
                    voucherUsed: appliedVoucher ? {
                        code: appliedVoucher.code,
                        discountAmount: calculateDiscount(appliedVoucher, totalHargaAwal),
                        voucherId: appliedVoucher.id
                    } : null
                };

                // --- CRITICAL FIX: USE setDoc WITH ID=CODE ---
                // Ini mencegah duplikasi. Jika kode ini entah bagaimana sudah ada, 
                // setDoc akan mengupdate doc yg ada, BUKAN membuat baru.
                // Tapi karena kita sudah cek di generateSmartUniqueCode, ini aman.
                await setDoc(doc(db, "pendaftaran_member", newRegistrationCode), pendaftar);

                // Update voucher usage if applied
                if (appliedVoucher) {
                    const voucherRef = doc(db, "vouchers", appliedVoucher.id);
                    await runTransaction(db, async (transaction) => {
                        const voucherDoc = await transaction.get(voucherRef);
                        if (voucherDoc.exists()) {
                            const currentUses = voucherDoc.data().currentUses || 0;
                            transaction.update(voucherRef, { currentUses: currentUses + 1 });
                        }
                    });
                }

                formContainer.classList.add('hidden');
                document.getElementById('kode-sukses').textContent = pendaftar.kodePendaftaran;
                updateSuccessPaymentInfo();
                const whatsappMsg = encodeURIComponent(`Bismillah Vinca Gym, saya ${pendaftar.nama} sudah mendaftar untuk paket ${pendaftar.paket} dengan kode pendaftaran ${pendaftar.kodePendaftaran}. Total bayar: ${formatRupiah(pendaftar.totalBayar)}. Mohon segera diproses. Barakallahu fiik.`);
                document.getElementById('whatsapp-confirm-btn').href = `https://wa.me/6285782919391?text=${whatsappMsg}`;

                successMessage.classList.remove('hidden');
            } catch (error) {
                console.error("Error adding document: ", error);
                alert("Pendaftaran gagal, silakan coba lagi. Error: " + error);
                submitButton.disabled = false;
                submitText.classList.remove('hidden');
                submitSpinner.classList.add('hidden');
            }
        });

        function copyToClipboard(text, buttonElement) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);

            const originalIcon = buttonElement.innerHTML;
            const tooltip = buttonElement.querySelector('.tooltip');
            buttonElement.innerHTML = '<i class="ph ph-check text-green-400"></i>';
            if (tooltip) tooltip.textContent = 'Tersalin!';

            setTimeout(() => {
                buttonElement.innerHTML = originalIcon;
                if (tooltip) tooltip.textContent = 'Salin';
            }, 2000);
        }

        copyKodeBtn.addEventListener('click', () => {
            const kode = document.getElementById('kode-sukses').textContent;
            copyToClipboard(kode, copyKodeBtn);
        });

        copyRekeningBtn.addEventListener('click', () => {
            const rekening = document.getElementById('rekening-nomor').textContent;
            copyToClipboard(rekening, copyRekeningBtn);
        });

        downloadPaymentBtn.addEventListener('click', () => {
            const downloadText = document.getElementById('download-text');
            const downloadIcon = document.getElementById('download-icon');
            const downloadSpinner = document.getElementById('download-spinner');

            downloadPaymentBtn.disabled = true;
            if (downloadText) downloadText.textContent = 'Mempersiapkan...';
            if (downloadIcon) downloadIcon.classList.add('hidden');
            if (downloadSpinner) downloadSpinner.classList.remove('hidden');

            const paymentInfo = document.getElementById('payment-info');
            html2canvas(paymentInfo, { backgroundColor: '#242424' }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'info-pembayaran-vinca-gym.png';
                link.href = canvas.toDataURL();
                link.click();

                downloadPaymentBtn.disabled = false;
                if (downloadText) downloadText.textContent = 'Unduh Info Pembayaran';
                if (downloadIcon) downloadIcon.classList.remove('hidden');
                if (downloadSpinner) downloadSpinner.classList.add('hidden');
            });
        });
    </script>
</body>
</html>
